<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Sistema Offline - Las Piconas (Touch) V8</title>

<style>

/* ==========================================================
     SISTEMA COMPLETO V8 - CSS ORDENADO
     PARTE 1/2 DEL CSS  (el resto viene en PARTE 2/5)
   ========================================================== */


/* ---------------------------
   VARIABLES GLOBALES
-----------------------------*/
:root{
  --bg:#0b0f14;
  --panel:#0f1720;
  --card:#0b1220;
  --accent:#ff6b35;
  --muted:#9aa4b2;
  --green:#28a745;
  --blue:#3b82f6;

  --pay-size:64px;
  --total-size:28px;

  --radius:12px;
  --shadow:0 6px 18px rgba(2,6,23,0.6);
}


/* ---------------------------
   RESETEO / BASE
-----------------------------*/
*{
  box-sizing:border-box;
  font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif;
}

html,body{
  height:100%;
  margin:0;
  background:linear-gradient(180deg,#06080a 0%, #0b0f14 100%);
  color:#e6eef6;
}


/* ---------------------------
   GRID PRINCIPAL
-----------------------------*/
.app{
  display:grid;
  grid-template-columns:360px 1fr;
  gap:14px;
  padding:14px;
  height:100vh;
}

/* Responsive */
@media(max-width:1024px){
  .app{
    display:flex;
    flex-direction:column;
    height:auto;
  }
}


/* ---------------------------
   SIDEBAR (left)
-----------------------------*/
.sidebar{
  background:var(--panel);
  border-radius:var(--radius);
  padding:12px;
  display:flex;
  flex-direction:column;
  box-shadow:var(--shadow);
}

.brand{
  font-weight:800;
  letter-spacing:0.6px;
  padding:8px 12px;
  font-size:18px;
  text-align:center;
  color:#fff;
}

.logo-preview{
  max-width:160px;
  margin:10px auto;
  display:block;
}

.controls-row{
  display:flex;
  gap:8px;
  margin-bottom:8px;
}

.input,
.qty{
  background:transparent;
  border:1px solid rgba(255,255,255,0.06);
  padding:10px;
  border-radius:8px;
  color:#e6eef6;
}

.categorias{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-top:8px;
}

.cat-btn{
  padding:10px 12px;
  border-radius:8px;
  border:1px solid rgba(255,255,255,0.04);
  cursor:pointer;
  font-weight:700;
  min-width:80px;
  background:transparent;
  color:#fff;
  text-align:center;
}


/* ---------------------------
   PRODUCTOS
-----------------------------*/
.products{
  margin-top:12px;
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:16px;
  overflow:auto;
  padding:6px;
  height:calc(100vh - 390px);
}

.prod-card{
  padding:20px;
  border-radius:14px;
  cursor:pointer;
  text-align:center;
  user-select:none;
  color:#fff;
  border:1px solid rgba(255,255,255,0.04);
  font-size:17px;
  transition:transform 0.1s ease;
}

.prod-card:hover{
  transform:scale(1.04);
}

.prod-name{
  font-weight:800;
  font-size:17px;
  margin-bottom:6px;
}

.prod-price{
  font-size:15px;
  color:var(--muted);
  margin-top:4px;
}


/* ---------------------------
   PANEL CENTRAL
-----------------------------*/
.center{
  background:var(--card);
  border-radius:var(--radius);
  padding:12px;
  display:flex;
  flex-direction:column;
  box-shadow:var(--shadow);
}


/* Topbar */
.topbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  flex-wrap:wrap;
  margin-bottom:12px;
}

.current-order{
  font-size:26px;
  font-weight:900;
  text-align:center;
  margin:10px 0;
}


/* ---------------------------
   VIEWER (productos agregados)
-----------------------------*/
.viewer{
  flex:1;
  background:linear-gradient(180deg,#071428,#071a2a);
  padding:12px;
  border-radius:10px;
  overflow:auto;
  font-size:16px;
}

.item-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:8px;
  padding:12px;
  border-bottom:1px dashed rgba(255,255,255,0.06);
  font-size:17px;
}

.comment-input{
  background:transparent;
  border:1px dashed rgba(255,255,255,0.08);
  padding:8px;
  border-radius:6px;
  color:#e6eef6;
  font-size:15px;
  width:100%;
}


/* ---------------------------
   CONTROLES ( + - eliminar cobrar )
-----------------------------*/
.controls{
  display:flex;
  gap:10px;
  margin-top:12px;
}

.action-btn{
  background:transparent;
  border:1px solid rgba(255,255,255,0.10);
  color:#fff;
  padding:10px 12px;
  border-radius:8px;
  cursor:pointer;
  font-size:17px;
  font-weight:700;
}

.control-btn{
  flex:1;
  padding:14px;
  border-radius:10px;
  background:var(--accent);
  color:#0b1220;
  font-weight:900;
  font-size:18px;
  border:none;
  cursor:pointer;
}


/* ---------------------------
   TOTALES POS (ESTILO C)
-----------------------------*/
.totals-box{
  margin-top:22px;
  background:linear-gradient(180deg,#08131f,#0d1826);
  border-radius:14px;
  padding:20px;
}

.total-row{
  display:flex;
  justify-content:space-between;
  padding:6px 0;
  font-size:22px;
}

.total-final{
  font-size:34px;
  font-weight:900;
  margin-top:12px;
  padding-top:12px;
  border-top:1px solid rgba(255,255,255,0.3);
  color:#ffffff;
}
/* ==========================================================
      CSS V8 ORDENADO ‚Äî CONTINUACI√ìN
========================================================== */


/* ---------------------------
   M√âTODO DE PAGO (GRANDES)
-----------------------------*/

.pay-methods{
  display:flex;
  gap:16px;
  margin-top:10px;
}

.pay-btn{
  flex:1;
  height:var(--pay-size);
  border-radius:16px;
  border:none;
  cursor:pointer;
  font-size:22px;
  font-weight:900;
  display:flex;
  align-items:center;
  justify-content:center;
  transition:0.15s;
  background:#1b2533;
  color:#aab4c4;
  box-shadow:0 0 0 2px rgba(255,255,255,0.06);
}

.pay-btn.active{
  background:var(--green);
  color:#fff;
  transform:scale(1.05);
  box-shadow:0 0 0 3px rgba(255,255,255,0.15);
}


/* ---------------------------
   BOT√ìN ‚ÄúCOBRAR‚Äù GRANDE SUPERIOR
-----------------------------*/
#btnCobrarTop{
  position:fixed;
  top:12px;
  left:50%;
  transform:translateX(-50%);
  z-index:1000;
  background:var(--green);
  color:#fff;
  border:none;
  padding:16px 28px;
  border-radius:12px;
  font-weight:900;
  font-size:22px;
  box-shadow:0 8px 20px rgba(0,0,0,0.35);
  cursor:pointer;
  display:none;
}


/* ---------------------------
   MEN√ö HAMBURGUESA
-----------------------------*/
#menuHamburguesa{
  display:none;
  position:fixed;
  top:12px;
  left:12px;
  z-index:1100;
  background:#111;
  border:none;
  color:white;
  font-size:30px;
  padding:8px 14px;
  border-radius:10px;
  cursor:pointer;
  box-shadow:0 4px 10px rgba(0,0,0,0.4);
}


/* ---------------------------
   MEN√ö LATERAL ADMIN
-----------------------------*/
#menuLateral{
  position:fixed;
  top:0;
  left:-280px;
  width:260px;
  height:100%;
  background:#111827;
  color:white;
  z-index:1050;
  padding-top:70px;
  transition:left .3s;
  box-shadow:4px 0 20px rgba(0,0,0,0.45);
}

#menuLateral a{
  display:block;
  padding:14px 18px;
  color:white;
  text-decoration:none;
  font-size:17px;
  border-bottom:1px solid rgba(255,255,255,0.05);
}

#menuLateral a:hover{
  background:#1f2937;
}


/* ---------------------------
   HISTORIAL / MODALES
-----------------------------*/

.history-modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.6);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:2000;
}

.history-box{
  background:#0f172a;
  width:90%;
  max-width:480px;
  border-radius:14px;
  padding:20px;
  box-shadow:0 0 30px rgba(0,0,0,0.5);
  overflow:auto;
  max-height:85%;
}

.history-item{
  padding:12px;
  background:rgba(255,255,255,0.05);
  border-radius:8px;
  margin-bottom:10px;
  font-size:16px;
}


/* ---------------------------
   LOGIN
-----------------------------*/

.login-wrap{
  position:fixed;
  inset:0;
  background:linear-gradient(90deg, rgba(2,6,23,0.9), rgba(4,10,27,0.95));
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:999;
}

.login-card{
  background:linear-gradient(180deg,#071428,#0b1220);
  padding:30px;
  border-radius:16px;
  min-width:360px;
  box-shadow:0 8px 30px rgba(2,6,23,0.7);
  color:#fff;
}

.login-card h2{
  text-align:center;
  margin:10px 0 14px;
}

.login-card .input{
  width:100%;
  margin-bottom:14px;
}

.login-logo{
  max-width:140px;
  display:block;
  margin:0 auto 14px;
}


/* ---------------------------
   HISTORIAL SIMPLE EN SIDEBAR
-----------------------------*/

.history{
  flex:1;
  overflow:auto;
}

.row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:14px;
  border-radius:12px;
  margin-bottom:10px;
  background:rgba(255,255,255,0.03);
}

.footer{
  font-size:12px;
  color:var(--muted);
  text-align:center;
  margin-top:8px;
}


/* ---------------------------
   SCROLLBAR MODERNO
-----------------------------*/
::-webkit-scrollbar{
  width:8px;
}
::-webkit-scrollbar-thumb{
  background:#1f2937;
  border-radius:10px;
}
::-webkit-scrollbar-track{
  background:#0f172a;
}


/* ---------------------------
   IMPRESI√ìN
-----------------------------*/
@media print{
  body *{
    visibility:hidden;
  }
  .print-area,
  .print-area *{
    visibility:visible;
  }
  .print-area{
    position:fixed;
    left:0;
    top:0;
    width:100%;
  }
}

@media print{
  @page{
    margin:3mm;
    size:80mm auto;
  }
}


/* ---------------------------
   FIN DEL CSS
-----------------------------*/

</style>
</head>
<body>

<!-- =========================================
     BOT√ìN COBRAR SUPERIOR (solo tras login)
========================================= -->
<button id="btnCobrarTop" title="Cobrar">COBRAR üíµ</button>


<!-- =========================================
     MEN√ö HAMBURGUESA (solo tras login)
========================================= -->
<button id="menuHamburguesa" title="Men√∫">‚ò∞</button>


<!-- =========================================
     MEN√ö LATERAL ADMIN
========================================= -->
<div id="menuLateral">

  <a href="#" data-action="addCat">‚ûï Crear Categor√≠a</a>
  <a href="#" data-action="editCat">‚úèÔ∏è Modificar Categor√≠a</a>
  <a href="#" data-action="delCat">‚ùå Eliminar Categor√≠a</a>

  <a href="#" data-action="addProd">‚ûï Crear Producto</a>
  <a href="#" data-action="editProd">‚úèÔ∏è Modificar Producto</a>
  <a href="#" data-action="delProd">‚ùå Eliminar Producto</a>

  <a href="#" data-action="openHistory">üìú Historial de Ventas</a>

  <a href="#" data-action="changeOrderPrefix">üî§ Cambiar prefijo de orden</a>

</div>



<!-- =========================================
     MODAL DE HISTORIAL
========================================= -->
<div class="history-modal" id="historyModal">
  <div class="history-box">
    <h2 style="margin-top:0;margin-bottom:14px;text-align:center">Historial de Ventas</h2>

    <div id="historyContent"></div>

    <button style="margin-top:20px;width:100%;padding:12px;font-size:17px;font-weight:800;border-radius:10px;background:#1f2937;color:white;cursor:pointer"
      onclick="closeHistoryModal()">
      CERRAR
    </button>
  </div>
</div>



<!-- =========================================
     LOGIN
========================================= -->
<div id="login" class="login-wrap">
  <div class="login-card">

    <img src="logo" class="login-logo" onerror="this.onerror=null;this.src='logo.png';" />

    <h2>Ingreso al Sistema</h2>

    <input id="user" class="input" placeholder="Usuario" />
    <input id="pass" class="input" type="password" placeholder="Clave" />

    <button id="btnLogin" class="control-btn" style="margin-top:12px;width:100%">Entrar</button>

    <div style="text-align:center;margin-top:14px;color:var(--muted);font-size:13px">
      Usuario: <b>CAJERO</b> ‚Äî Clave: <b>123</b>
    </div>

  </div>
</div>



<!-- =========================================
     APP COMPLETA
========================================= -->
<div class="app" id="appRoot" style="display:none;">


  <!-- ========================
       SIDEBAR IZQUIERDO
  ========================= -->
  <div class="sidebar">

    <div class="brand">Las Piconas - Punto de Venta V8</div>
    <img src="logo" alt="logo" class="logo-preview" onerror="this.onerror=null;this.src='logo.png';" />


    <!-- CANTIDAD + BORRAR √öLTIMO -->
    <div class="controls-row">
      <input id="qty" class="qty" type="number" min="1" value="1" style="flex:1" />
      <button id="btnDeleteLast" class="action-btn">Borrar</button>
    </div>


    <!-- CATEGOR√çAS -->
    <div style="margin-top:6px">
      <div style="font-size:13px;color:var(--muted);padding:6px">Categor√≠as</div>
      <div class="categorias" id="categorias"></div>
    </div>


    <!-- PRODUCTOS -->
    <div style="margin-top:16px">
      <div style="font-size:13px;color:var(--muted);padding:6px">Productos</div>
      <div class="products" id="products"></div>
    </div>

  </div> <!-- FIN SIDEBAR -->




  <!-- ========================
       PANEL CENTRAL
  ========================= -->
  <div class="center">

    <!-- TOPBAR -->
    <div class="topbar">
      <div style="font-weight:800;font-size:20px">Visor de Cliente</div>
    </div>

    <!-- ORDEN ACTUAL -->
    <div class="current-order" id="currentOrder">Orden: AF000001</div>


    <!-- VISOR -->
    <div class="viewer" id="viewer"></div>



    <!-- SELECCI√ìN M√âTODO DE PAGO -->
    <div class="pay-methods">
      <button id="payCash" class="pay-btn active">EFECTIVO</button>
      <button id="payCard" class="pay-btn">TARJETA</button>
    </div>



    <!-- CONTROLES -->
    <div class="controls">
      <button id="minus" class="action-btn">-</button>
      <button id="plus" class="action-btn">+</button>
      <button id="applyDiscount" class="action-btn">Descuento</button>

      <button id="finalizar" class="control-btn">Cobrar</button>
    </div>



    <!-- TOTALES (ESTILO C) -->
    <div class="totals-box">
      <div class="total-row">
        <span>Subtotal</span>
        <span id="subtotal">Q0.00</span>
      </div>

      <div class="total-row">
        <span>Descuento</span>
        <span id="discount">Q0.00</span>
      </div>

      <div class="total-final">
        TOTAL: <span id="total">Q0.00</span>
      </div>
    </div>


  </div> <!-- FIN PANEL CENTRAL -->


</div> <!-- FIN APP -->



<!-- =========================================
     INICIO DEL SCRIPT (PARTE 4 CONTIN√öA)
========================================= -->
<script>
/* ==========================================================
      SISTEMA V8 - JAVASCRIPT ORDENADO (PARTE 1/2)
========================================================== */


/* ========================================
   VARIABLES GLOBALES Y LOCALSTORAGE
======================================== */

let CATEGORIES = JSON.parse(localStorage.getItem('v8_categories') || '{}');
let cart = JSON.parse(localStorage.getItem('v8_cart') || '[]');
let discount = 0;

let orderPrefix = localStorage.getItem('v8_order_prefix') || 'AF';
let orderNumber = Number(localStorage.getItem('v8_order_number') || '1');

let paymentMethod = "EFECTIVO";

function saveCategories(){
  localStorage.setItem('v8_categories', JSON.stringify(CATEGORIES));
}

function saveCart(){
  localStorage.setItem('v8_cart', JSON.stringify(cart));
}

function saveOrderCounter(){
  localStorage.setItem('v8_order_prefix', orderPrefix);
  localStorage.setItem('v8_order_number', orderNumber);
}


/* ========================================
   FORMATO
======================================== */
function fmt(q){
  return "Q" + Number(q).toFixed(2);
}



/* ========================================
   RENDER CATEGOR√çAS
======================================== */
function renderCategories(){
  const box = document.getElementById("categorias");
  box.innerHTML = "";

  Object.keys(CATEGORIES).forEach(cat => {
    const b = document.createElement("button");
    b.className = "cat-btn";
    b.textContent = cat;

    if(CATEGORIES[cat].color){
      b.style.background = CATEGORIES[cat].color;
    }

    b.onclick = () => showProducts(cat);

    box.appendChild(b);
  });
}



/* ========================================
   RENDER PRODUCTOS
======================================== */
function showProducts(cat){
  const box = document.getElementById("products");
  box.innerHTML = "";

  const arr = CATEGORIES[cat].products || [];

  arr.forEach(p => {
    const card = document.createElement("div");
    card.className = "prod-card";

    if(p.color){
      card.style.background = p.color;
    } else {
      card.style.background = CATEGORIES[cat].color || "#1f2937";
    }

    card.innerHTML = `
      <div class="prod-name">${p.name}</div>
      <div class="prod-price">${fmt(p.price)}</div>
    `;

    card.onclick = () => addToCart(p);

    box.appendChild(card);
  });
}



/* ========================================
   AGREGAR PRODUCTO AL CARRITO
======================================== */
function addToCart(p){
  const qty = Number(document.getElementById("qty").value) || 1;

  const found = cart.find(item => item.name === p.name && item.price === p.price);

  if(found){
    found.qty += qty;
  } else {
    cart.push({
      name: p.name,
      price: p.price,
      qty: qty,
      comment: ""
    });
  }

  saveCart();
  renderViewer();
}



/* ========================================
   RENDER VIEWER DEL CARRITO
======================================== */
function renderViewer(){
  const v = document.getElementById("viewer");
  v.innerHTML = "";

  cart.forEach((it, index) => {

    const row = document.createElement("div");
    row.className = "item-row";

    const left = document.createElement("div");
    left.style.flex = "1";

    left.innerHTML = `
      <div style="font-weight:800;font-size:18px">${it.qty} x ${it.name}</div>
    `;

    const commentInput = document.createElement("input");
    commentInput.className = "comment-input";
    commentInput.placeholder = "Comentario (opcional)";
    commentInput.value = it.comment || "";

    commentInput.oninput = (e)=>{
      it.comment = e.target.value;
      saveCart();
    };

    left.appendChild(commentInput);


    const right = document.createElement("div");
    right.style.width = "160px";
    right.style.textAlign = "right";

    right.innerHTML = `
      ${fmt(it.price * it.qty)}
      <div style="margin-top:8px;display:flex;gap:6px;justify-content:flex-end">
        <button class="action-btn" onclick="minusItem(${index})">-</button>
        <button class="action-btn" onclick="plusItem(${index})">+</button>
        <button class="action-btn" style="background:#e74c3c" onclick="deleteItem(${index})">X</button>
      </div>
    `;

    row.appendChild(left);
    row.appendChild(right);

    v.appendChild(row);
  });

  recalcTotals();
}



/* ========================================
   OPERACIONES DEL CARRITO
======================================== */

function minusItem(i){
  if(cart[i].qty > 1){
    cart[i].qty--;
  } else {
    cart.splice(i,1);
  }
  saveCart();
  renderViewer();
}

function plusItem(i){
  cart[i].qty++;
  saveCart();
  renderViewer();
}

function deleteItem(i){
  cart.splice(i,1);
  saveCart();
  renderViewer();
}



/* ========================================
   RECALCULAR TOTALES
======================================== */
function recalcTotals(){
  const subtotal = cart.reduce((s,i)=> s + i.qty*i.price, 0);
  const total = Math.max(0, subtotal - discount);

  document.getElementById("subtotal").textContent = fmt(subtotal);
  document.getElementById("discount").textContent = fmt(discount);
  document.getElementById("total").textContent = fmt(total);
}



/* ========================================
   M√âTODO DE PAGO
======================================== */
document.getElementById("payCash").onclick = ()=>{
  paymentMethod = "EFECTIVO";
  document.getElementById("payCash").classList.add("active");
  document.getElementById("payCard").classList.remove("active");
};

document.getElementById("payCard").onclick = ()=>{
  paymentMethod = "TARJETA";
  document.getElementById("payCard").classList.add("active");
  document.getElementById("payCash").classList.remove("active");
};



/* ========================================
   MODIFICAR CANTIDAD DESDE BOTONES
======================================== */
document.getElementById("plus").onclick = ()=>{
  document.getElementById("qty").stepUp();
};

document.getElementById("minus").onclick = ()=>{
  document.getElementById("qty").stepDown();
};



/* ========================================
   DESCUENTO
======================================== */
document.getElementById("applyDiscount").onclick = ()=>{
  const d = parseFloat(prompt("Descuento en Q:", discount));
  if(!isNaN(d)){
    discount = d;
    recalcTotals();
  }
};



/* ========================================
   BORRAR √öLTIMO
======================================== */
document.getElementById("btnDeleteLast").onclick = ()=>{
  if(cart.length > 0){
    cart.pop();
    saveCart();
    renderViewer();
  }
};



/* ========================================
   CAMBIAR PREFIJO DE ORDEN (A-Z)
   CAMBIAR N√öMERO (000001 - etc)
======================================== */

function updateOrderLabel(){
  const padded = String(orderNumber).padStart(6,'0');
  document.getElementById("currentOrder").textContent =
    "Orden: " + orderPrefix + padded;
}

function openChangeOrderPrefix(){
  const pref = prompt("Prefijo de orden (letras):", orderPrefix);
  if(!pref) return;

  const num = prompt("N√∫mero inicial:", orderNumber);
  if(!num) return;

  if(isNaN(Number(num))){
    alert("N√∫mero inv√°lido.");
    return;
  }

  orderPrefix = pref.toUpperCase();
  orderNumber = Number(num);
  saveOrderCounter();
  updateOrderLabel();
}



/* ========================================
   ADMIN MENU (desde el men√∫ hamburguesa)
======================================== */

function toggleMenu(){
  const m = document.getElementById("menuLateral");
  m.style.left = (m.style.left === "0px") ? "-280px" : "0px";
}

document.getElementById("menuHamburguesa").onclick = toggleMenu;


document.querySelectorAll("#menuLateral a").forEach(a=>{
  a.onclick = (e)=>{
    e.preventDefault();
    toggleMenu();

    const act = a.dataset.action;

    // autenticaci√≥n ADMIN
    const code = prompt("Clave admin:");
    if(code !== "22782522"){
      alert("Clave incorrecta");
      return;
    }

    if(act === "addCat")   adminAddCategory();
    if(act === "editCat")  adminEditCategory();
    if(act === "delCat")   adminDeleteCategory();

    if(act === "addProd")  adminAddProduct();
    if(act === "editProd") adminEditProduct();
    if(act === "delProd")  adminDeleteProduct();

    if(act === "openHistory") openHistoryModal();
    if(act === "changeOrderPrefix") openChangeOrderPrefix();
  };
});



/* ========================================
   FUNCIONES ADMIN (CRUD)
======================================== */

function adminAddCategory(){
  const name = prompt("Nombre nueva categor√≠a:");
  if(!name) return;
  if(CATEGORIES[name]){
    alert("Ya existe.");
    return;
  }

  const color = prompt("Color HEX (ej: #ff6b35):", "#1f2937");

  CATEGORIES[name] = {
    color: color,
    products: []
  };

  saveCategories();
  renderCategories();
}

function adminEditCategory(){
  const name = prompt("Nombre categor√≠a a modificar:");
  if(!name || !CATEGORIES[name]){
    alert("No existe.");
    return;
  }

  const newName = prompt("Nuevo nombre:", name);
  if(!newName) return;

  const color = prompt("Nuevo color HEX:", CATEGORIES[name].color);

  CATEGORIES[newName] = {
    color: color,
    products: CATEGORIES[name].products
  };

  if(newName !== name){
    delete CATEGORIES[name];
  }

  saveCategories();
  renderCategories();
}

function adminDeleteCategory(){
  const name = prompt("Categor√≠a a eliminar:");
  if(!name || !CATEGORIES[name]) return;

  if(!confirm("¬øEliminar categor√≠a y productos?")) return;

  delete CATEGORIES[name];

  saveCategories();
  renderCategories();
  document.getElementById("products").innerHTML = "";
}

function adminAddProduct(){
  const cat = prompt("Categor√≠a:");
  if(!cat || !CATEGORIES[cat]){
    alert("No existe categor√≠a.");
    return;
  }

  const name = prompt("Nombre producto:");
  if(!name) return;

  const price = parseFloat(prompt("Precio:"));
  if(isNaN(price)){
    alert("Precio inv√°lido.");
    return;
  }

  const color = CATEGORIES[cat].color || "#1f2937";

  CATEGORIES[cat].products.push({
    name, price, color
  });

  saveCategories();
  showProducts(cat);
}

function adminEditProduct(){
  const cat = prompt("Categor√≠a:");
  if(!cat || !CATEGORIES[cat]){
    alert("No existe categor√≠a.");
    return;
  }

  const name = prompt("Producto a modificar:");
  const prod = CATEGORIES[cat].products.find(p => p.name === name);

  if(!prod){
    alert("Producto no encontrado.");
    return;
  }

  const newName = prompt("Nuevo nombre:", prod.name);
  const newPrice = parseFloat(prompt("Nuevo precio:", prod.price));

  if(isNaN(newPrice)){
    alert("Precio inv√°lido.");
    return;
  }

  prod.name = newName;
  prod.price = newPrice;

  saveCategories();
  showProducts(cat);
}

function adminDeleteProduct(){
  const cat = prompt("Categor√≠a:");
  if(!cat || !CATEGORIES[cat]){
    alert("No existe categor√≠a.");
    return;
  }

  const name = prompt("Producto a eliminar:");
  const arr = CATEGORIES[cat].products;
  const idx = arr.findIndex(p=>p.name===name);

  if(idx === -1){
    alert("No encontrado.");
    return;
  }

  arr.splice(idx,1);

  saveCategories();
  showProducts(cat);
}



/* ========================================
   HISTORIAL (solo modal)
======================================== */

function openHistoryModal(){
  renderHistoryModal();
  document.getElementById("historyModal").style.display = "flex";
}

function closeHistoryModal(){
  document.getElementById("historyModal").style.display = "none";
}

function renderHistoryModal(){
  const hist = JSON.parse(localStorage.getItem('v8_sales') || '[]');
  const box = document.getElementById("historyContent");
  box.innerHTML = "";

  if(hist.length === 0){
    box.innerHTML = `<div class="history-item">No hay ventas a√∫n.</div>`;
    return;
  }

  hist.slice().reverse().forEach(sale => {

    const div = document.createElement("div");
    div.className = "history-item";

    div.innerHTML = `
      <b>${sale.orderLabel}</b> ‚Äî ${fmt(sale.total)}<br>
      <span style="font-size:13px;color:#9aa4b2">${sale.dateFormatted}</span>
      <br>
      <button class="action-btn" style="margin-top:8px" onclick='reprintSale("${sale.id}")'>Reimprimir</button>
      <button class="action-btn" style="margin-top:8px" onclick='reprintKitchen("${sale.id}")'>Cocina</button>
    `;

    box.appendChild(div);
  });
}



/* ========================================
   LOGIN
======================================== */

document.getElementById("btnLogin").onclick = ()=>{
  const u = document.getElementById("user").value.trim();
  const p = document.getElementById("pass").value.trim();

  if(u === "CAJERO" && p === "123"){
    document.getElementById("login").style.display = "none";
    document.getElementById("appRoot").style.display = "grid";
    document.getElementById("btnCobrarTop").style.display = "block";

    updateOrderLabel();
    renderCategories();
    renderViewer();
  } else {
    alert("Usuario o clave incorrecta");
  }
};
/* ==========================================================
      SISTEMA V8 - JAVASCRIPT ORDENADO (PARTE 2/2)
========================================================== */


/* ========================================
   GUARDAR VENTA
======================================== */
function saveSale(sale){
  const hist = JSON.parse(localStorage.getItem('v8_sales') || '[]');
  hist.push(sale);
  localStorage.setItem('v8_sales', JSON.stringify(hist));
}



/* ========================================
   CREAR OBJETO DE VENTA
======================================== */
function buildSaleObject(){
  const id = orderPrefix + String(orderNumber).padStart(6,'0');
  const date = new Date();
  const dateFormatted = date.toLocaleString();

  const subtotal = cart.reduce((s,i)=> s + i.qty*i.price, 0);
  const total = Math.max(0, subtotal - discount);

  return {
    id,
    orderLabel: id,
    date: date.toISOString(),
    dateFormatted,
    items: cart.map(i=>({
      name:i.name,
      qty:i.qty,
      price:i.price,
      comment:i.comment || ""
    })),
    subtotal,
    discount,
    total,
    payment: paymentMethod
  };
}



/* ========================================
   GENERAR HTML PARA IMPRESI√ìN CLIENTE
======================================== */
function buildClientHTML(s){
  return `
  <!doctype html>
  <html><head><meta charset="utf-8">
  <style>
    body{ font-family:Arial; margin:0; padding:6px; }
    @page{ size:80mm auto; margin:3mm; }
    .ticket{ width:76mm; }
    h2{ text-align:center; margin:4px 0 6px; font-size:20px; }
    table{ width:100%; font-size:15px; }
  </style>
  </head>
  <body onload="setTimeout(()=>window.print(),200)">
    <div class="ticket">
      <h2>LAS PICONAS</h2>
      <div style="text-align:center">${s.dateFormatted}</div>
      <div style="text-align:center;font-size:22px;font-weight:900;margin:8px 0">
        ORDEN ${s.orderLabel}
      </div>

      <table>
        <tbody>
          ${s.items.map(it=>`
            <tr>
              <td>${it.qty} x ${it.name}
                ${it.comment? `<div style='font-size:12px;color:#333'>(${it.comment})</div>` :""}
              </td>
              <td style="text-align:right">${fmt(it.qty*it.price)}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>

      <br>
      <div><b>Subtotal:</b> ${fmt(s.subtotal)}</div>
      <div><b>Descuento:</b> ${fmt(s.discount)}</div>
      <div style="font-size:20px;font-weight:900;margin-top:6px">
        TOTAL: ${fmt(s.total)}
      </div>

      <div style="margin-top:8px;font-size:14px">
        Pago: ${s.payment}
      </div>

      <div style="text-align:center;margin-top:8px;font-size:13px">
        Gracias por su compra
      </div>
    </div>
  </body></html>`;
}



/* ========================================
   GENERAR HTML PARA IMPRESI√ìN COCINA
======================================== */
function buildKitchenHTML(s){
  return `
  <!doctype html>
  <html><head><meta charset="utf-8">
  <style>
    body{ font-family:Arial; margin:0; padding:6px; }
    @page{ size:80mm auto; margin:3mm; }
    .ticket{ width:76mm; font-size:18px; }
  </style>
  </head>
  <body onload="setTimeout(()=>window.print(),200)">
    <div class="ticket">
      <h2 style="text-align:center;margin:4px 0 10px;font-size:22px;">COCINA</h2>

      <div style="text-align:center;font-size:20px;font-weight:900;margin-bottom:6px">
        ORDEN ${s.orderLabel}
      </div>

      ${s.items.map(it=>`
        <div style="margin-bottom:10px">
          <b>${it.qty} x ${it.name}</b>
          ${it.comment? `<div style='font-size:15px;color:#b00;margin-left:6px'>(${it.comment})</div>`:""}
        </div>
      `).join("")}

      <div style="text-align:center;margin-top:10px;font-size:14px">--- FIN ---</div>
    </div>
  </body></html>`;
}



/* ========================================
   IMPRIMIR TICKET CLIENTE
======================================== */
function reprintSale(id){
  const hist = JSON.parse(localStorage.getItem('v8_sales') || '[]');
  const sale = hist.find(x=>x.id===id);
  if(!sale){ alert("No encontrado"); return; }

  const html = buildClientHTML(sale);
  const w = window.open("", "_blank", "width=420,height=720");
  w.document.write(html);
  w.document.close();
}



/* ========================================
   IMPRIMIR TICKET COCINA
======================================== */
function reprintKitchen(id){
  const hist = JSON.parse(localStorage.getItem('v8_sales') || '[]');
  const sale = hist.find(x=>x.id===id);
  if(!sale){ alert("No encontrado"); return; }

  const html = buildKitchenHTML(sale);
  const w = window.open("", "_blank", "width=420,height=720");
  w.document.write(html);
  w.document.close();
}



/* ========================================
   FINALIZAR VENTA
======================================== */
document.getElementById("finalizar").onclick =
document.getElementById("btnCobrarTop").onclick = ()=>{

  if(cart.length === 0){
    alert("No hay productos.");
    return;
  }

  const sale = buildSaleObject();
  saveSale(sale);

  // imprimir CLIENTE
  const htmlClient = buildClientHTML(sale);
  const win1 = window.open("", "_blank", "width=420,height=720");
  win1.document.write(htmlClient);
  win1.document.close();

  // imprimir COCINA
  const htmlKitchen = buildKitchenHTML(sale);
  const win2 = window.open("", "_blank", "width=420,height=720");
  win2.document.write(htmlKitchen);
  win2.document.close();

  // reset
  cart = [];
  discount = 0;
  orderNumber++;

  saveCart();
  saveOrderCounter();

  renderViewer();
  updateOrderLabel();

  alert("Venta registrada e impresiones enviadas.");
};



/* ========================================
   CIERRE DE TURNO
======================================== */
function closeShift(){
  const code = prompt("C√≥digo de cierre:");
  if(code !== "22782522"){
    alert("Incorrecto");
    return;
  }

  const hist = JSON.parse(localStorage.getItem('v8_sales') || '[]');
  if(hist.length === 0){
    alert("No hay ventas.");
    return;
  }

  let totalEfectivo = 0;
  let totalTarjeta = 0;
  let totalGeneral = 0;

  hist.forEach(s=>{
    if(s.payment === "EFECTIVO"){
      totalEfectivo += s.total;
    } else {
      totalTarjeta += s.total;
    }
    totalGeneral += s.total;
  });

  const html = `
  <!doctype html>
  <html><head><meta charset="utf-8">
  <style>
    body{ font-family:Arial; padding:6px; }
    @page{ size:80mm auto; margin:3mm; }
  </style>
  </head>
  <body onload="setTimeout(()=>window.print(),200)">
    <h3 style="text-align:center;margin:4px 0 6px">CIERRE DE TURNO</h3>
    <div>Total Efectivo: Q${totalEfectivo.toFixed(2)}</div>
    <div>Total Tarjeta: Q${totalTarjeta.toFixed(2)}</div>
    <hr>
    <div><b>Total General: Q${totalGeneral.toFixed(2)}</b></div>
    <br>
    <div style="font-size:12px">Ventas incluidas:</div>
    ${hist.map(s=> `${s.orderLabel} - ${fmt(s.total)}<br>` ).join("")}
  </body></html>
  `;

  const w = window.open("", "_blank", "width=420,height=720");
  w.document.write(html);
  w.document.close();

  // limpiar historial
  localStorage.setItem('v8_sales', JSON.stringify([]));
  alert("Cierre realizado.");
}



/* ========================================
   ESCUCHAR STORAGE (multiventana)
======================================== */
window.addEventListener("storage", ev=>{
  if(ev.key === "v8_categories"){
    CATEGORIES = JSON.parse(ev.newValue || '{}');
    renderCategories();
  }
  if(ev.key === "v8_cart"){
    cart = JSON.parse(ev.newValue || '[]');
    renderViewer();
  }
  if(ev.key === "v8_order_prefix" || ev.key==="v8_order_number"){
    orderPrefix = localStorage.getItem('v8_order_prefix') || orderPrefix;
    orderNumber = Number(localStorage.getItem('v8_order_number') || orderNumber);
    updateOrderLabel();
  }
});



/* ========================================
   INICIALIZACI√ìN
======================================== */
function init(){
  updateOrderLabel();
  renderCategories();
  renderViewer();
}

init();


</script>

</body>
</html>


<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Control Administrativo de Parqueo ‚Äî PICONAS (Pro)</title>

  <!-- Chart.js (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#071021;
      --panel: rgba(6,11,17,0.85);
      --card: rgba(255,255,255,0.02);
      --accent:#06b6d4;
      --accent-2:#ff7a59;
      --muted:#9aa6b2;
      --radius:12px;
      --glass: rgba(255,255,255,0.03);
      --success:#10b981;
      --danger:#ef4444;
      --text:#e6eef3;
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial; color:var(--text); background:var(--bg);}

    /* Full-page blurred background image (user provided 121212.png) */
    body::before{
      content:"";
      position:fixed;
      inset:0;
      background-image: url('121212.png');
      background-size: cover;
      background-position: center;
      filter: blur(6px) brightness(0.45);
      z-index:0;
    }

    .wrap{position:relative; z-index:1; min-height:100vh; display:flex; gap:18px; padding:20px; align-items:flex-start;}
    @media(max-width:1000px){ .wrap{flex-direction:column; padding:12px} }

    /* SIDEBAR */
    .sidebar{width:280px; min-width:220px; background:var(--panel); border-radius:var(--radius); padding:18px; box-shadow:0 12px 40px rgba(0,0,0,0.6);}
    .brand{display:flex; gap:12px; align-items:center}
    .logo{width:48px;height:48px;border-radius:10px; background:linear-gradient(90deg,var(--accent), #0ea5ad); display:flex;align-items:center;justify-content:center; font-weight:700; color:#012;}
    .small{font-size:13px;color:var(--muted)}
    .menu{margin-top:14px; display:flex; flex-direction:column; gap:6px}
    .menu button{background:transparent;border:none;color:var(--muted); text-align:left;padding:10px;border-radius:8px; cursor:pointer}
    .menu button.active{color:var(--accent); background: linear-gradient(90deg, rgba(6,182,212,0.06), rgba(255,122,89,0.03)); font-weight:600}

    /* MAIN CONTENT */
    .main{flex:1; display:flex; flex-direction:column; gap:12px}
    .topbar{display:flex; justify-content:space-between; align-items:center; gap:12px}
    .title{font-size:18px; font-weight:700}
    .controls{display:flex; gap:8px; align-items:center}

    .card{background:var(--card); border-radius:12px; padding:14px; box-shadow: 0 8px 24px rgba(2,6,23,0.6);}
    .form-row{display:flex; gap:8px; align-items:center}
    input[type="text"], input[type="search"], select { padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:var(--text); outline:none; }
    button.btn { padding:8px 12px; border-radius:8px; border:none; cursor:pointer; background:rgba(255,255,255,0.03); color:var(--text); }
    button.btn.primary{ background: linear-gradient(90deg,var(--accent), #0ea5ad); color:#012; font-weight:600; }
    button.btn.warn{ background: linear-gradient(90deg,var(--accent-2), #ff936e); color:#2b0d00; font-weight:600; }
    button.btn.ghost{ background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted); }

    /* Table */
    .table-wrap{ overflow:auto; margin-top:12px; max-height:60vh; }
    table{ width:100%; border-collapse:collapse; font-size:14px; }
    th, td{ padding:10px 8px; border-bottom:1px solid rgba(255,255,255,0.03); text-align:center; color:var(--text); }
    th{ font-size:13px; color:var(--muted); background:rgba(0,0,0,0.12); position:sticky; top:0; z-index:1; }
    tr.active{ background: linear-gradient(90deg, rgba(6,182,212,0.04), rgba(255,122,89,0.01)); }

    /* Right column / stats */
    .rightcol{ width:360px; min-width:260px; display:flex; flex-direction:column; gap:12px;}
    .stats{ display:flex; gap:10px; flex-wrap:wrap; }
    .stat{ flex:1; min-width:120px; background:rgba(255,255,255,0.015); padding:12px; border-radius:10px; text-align:center; }
    .stat h3{ margin:0; font-size:20px; }
    .stat p{ margin:6px 0 0; color:var(--muted); font-size:13px; }

    footer{ color:var(--muted); text-align:center; margin-top:8px; font-size:13px; }

    /* responsive tweaks */
    @media(max-width:1000px){
      .rightcol{ width:100%; order:2; }
      .sidebar{ width:100%; order:3; }
      .main{ order:1; }
    }

    /* small helpers */
    .badge{ padding:6px 10px; border-radius:999px; font-size:12px; }
    .barcode{ max-width:160px; margin-top:8px; }
    .muted{ color:var(--muted); font-size:13px; }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">P</div>
        <div>
          <div style="font-weight:700">PICONAS ‚Äî Parqueo</div>
          <div class="small">Administraci√≥n local</div>
        </div>
      </div>

      <div class="menu" id="menu">
        <button data-view="dashboard" class="active">üìä Dashboard</button>
        <button data-view="registro">üìã Historial</button>
        <button data-view="export">‚¨áÔ∏è Exportar / Importar</button>
        <button data-view="config">‚öôÔ∏è Configuraci√≥n</button>
      </div>

      <div style="margin-top:12px" class="small">
        Datos guardados en navegador (LocalStorage). Im√°genes: <code>IMAGEN1.png</code>, <code>121212.png</code>
      </div>
    </aside>

    <!-- Main content -->
    <main class="main">
      <div class="topbar">
        <div>
          <div class="title">Control Administrativo de Parqueo ‚Äî PICONAS</div>
          <div class="small">Interfaz profesional ‚Ä¢ Misma l√≥gica de tarifas</div>
        </div>

        <div class="controls">
          <input id="search" type="search" placeholder="Buscar por placa o marca..." style="padding:8px 10px; border-radius:8px; background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--text)" />
          <button class="btn ghost" id="btnClearAll" title="Limpiar todos los registros">Limpiar</button>
          <button class="btn primary" id="btnExportCSV" title="Exportar CSV">Exportar CSV</button>
          <button class="btn" id="btnPrintSummary">Imprimir resumen</button>
        </div>
      </div>

      <!-- Dashboard view -->
      <section id="view-dashboard" class="card view">
        <div style="display:flex; gap:12px; align-items:flex-start;">
          <div style="flex:1;">
            <div class="card">
              <h3 style="margin:0">Registrar ingreso r√°pido</h3>
              <div style="height:10px"></div>
              <div class="form-row">
                <input id="placa" type="text" placeholder="Placa del veh√≠culo" style="flex:1" />
                <input id="marca" type="text" placeholder="Marca" style="width:180px" />
                <button class="btn primary" id="btnIngresar">Ingresar</button>
                <button class="btn warn" id="btnGym">GYM (Q0)</button>
              </div>
            </div>

            <div class="card" style="margin-top:12px;">
              <h3 style="margin:0">Registros actuales</h3>
              <div class="table-wrap">
                <table>
                  <thead>
                    <tr><th>Placa</th><th>Marca</th><th>Ingreso</th><th>Salida</th><th>Total Q</th><th>Acciones</th></tr>
                  </thead>
                  <tbody id="registro"></tbody>
                </table>
              </div>
            </div>
          </div>

          <aside class="rightcol">
            <div class="card">
              <h3 style="margin:0">Resumen del Turno</h3>
              <div class="stats" id="resumenStats" style="margin-top:12px;">
                <div class="stat">
                  <h3 id="statActivos">0</h3>
                  <p>Veh√≠culos activos</p>
                </div>
                <div class="stat">
                  <h3 id="statTotal">Q0.00</h3>
                  <p>Total recaudado</p>
                </div>
                <div class="stat">
                  <h3 id="statEntradas">0</h3>
                  <p>Entradas hoy</p>
                </div>
              </div>

              <div style="height:12px"></div>
              <canvas id="chart" height="220" style="width:100%"></canvas>
            </div>

            <div class="card">
              <h4 style="margin:0">Detalle R√°pido</h4>
              <div style="height:8px"></div>
              <div id="quickInfo" class="muted">Selecciona un registro para ver detalles e imprimir.</div>
            </div>
          </aside>
        </div>
      </section>

      <!-- Historial view -->
      <section id="view-registro" class="card view" style="display:none;">
        <h3>Historial completo</h3>
        <div class="table-wrap">
          <table>
            <thead><tr><th>#</th><th>Placa</th><th>Marca</th><th>Ingreso</th><th>Salida</th><th>Minutos</th><th>Total Q</th><th>Acciones</th></tr></thead>
            <tbody id="historial"></tbody>
          </table>
        </div>
      </section>

      <!-- Export / Import view -->
      <section id="view-export" class="card view" style="display:none;">
        <h3>Exportar / Importar datos</h3>
        <div style="display:flex; gap:8px; align-items:center;">
          <button class="btn primary" id="exportJSON">Exportar JSON</button>
          <button class="btn" id="importJSONBtn">Importar JSON</button>
          <input type="file" id="fileImport" accept="application/json" style="display:none" />
        </div>
        <div id="importResult" style="margin-top:12px" class="muted"></div>
      </section>

      <!-- Config view -->
      <section id="view-config" class="card view" style="display:none;">
        <h3>Configuraci√≥n</h3>
        <p class="muted">Modo administrativo local. Las tarifas son las originales y no cambian aqu√≠.</p>
        <div style="margin-top:8px;">
          <button class="btn" id="btnResetTarifas">Restaurar tarifas originales</button>
        </div>
      </section>

      <footer>&copy; MarckBusiness 2025 ‚Äî Sistema administrativo</footer>
    </main>
  </div>

  <script>
    /* ========= Sistema administrativo avanzado (sin login) ========= */

    // Storage key
    const STORAGE_KEY = 'parqueo_admin_pro_v1';

    // Cargar registros desde localStorage con catch
    let registros = [];
    try {
      registros = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      if (!Array.isArray(registros)) registros = [];
    } catch (err) {
      console.error('Error leyendo localStorage:', err);
      registros = [];
    }

    // Mantener exactamente las mismas tarifas originales
    const tarifas = [
      { min: 0, max: 5, precio: 0 },
      { min: 6, max: 35, precio: 5 },
      { min: 36, max: 65, precio: 8 },
      { min: 66, max: 95, precio: 13 },
      { min: 96, max: 125, precio: 16 },
      { min: 126, max: 155, precio: 21 },
      { min: 156, max: 185, precio: 24 },
      { min: 186, max: 215, precio: 29 },
      { min: 216, max: 245, precio: 32 },
      { min: 246, max: 275, precio: 37 },
      { min: 276, max: 305, precio: 40 },
      { min: 306, max: 335, precio: 45 },
      { min: 336, max: 365, precio: 48 },
      { min: 366, max: 395, precio: 53 },
      { min: 396, max: 425, precio: 56 },
      { min: 426, max: 455, precio: 61 },
      { min: 456, max: 485, precio: 64 },
      { min: 486, max: 515, precio: 69 },
      { min: 516, max: 545, precio: 72 },
      { min: 546, max: 575, precio: 77 },
      { min: 576, max: 605, precio: 80 },
      { min: 606, max: 635, precio: 85 },
      { min: 636, max: 665, precio: 88 }
    ];

    function uid(prefix='id'){ return prefix + '_' + Math.random().toString(36).slice(2,9); }
    function save(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(registros)); }catch(e){ console.error('Error guardando localStorage', e); } }

    // Calcular pago (misma l√≥gica)
    function calcularPago(horaIngreso, horaSalida){
      const entrada = new Date(horaIngreso);
      const salida = new Date(horaSalida);
      const minutos = Math.ceil((salida - entrada) / 60000);
      for (let i=0;i<tarifas.length;i++){
        if (minutos >= tarifas[i].min && minutos <= tarifas[i].max) return tarifas[i].precio;
      }
      return tarifas[tarifas.length - 1].precio;
    }

    // Render tabla principal
    function actualizarTabla(){
      const tbody = document.getElementById('registro');
      tbody.innerHTML = '';
      registros.forEach((r, idx) => {
        const tr = document.createElement('tr');
        if (!r.horaSalida) tr.classList.add('active');
        tr.innerHTML = `
          <td>${escapeHtml(r.placa)}</td>
          <td>${escapeHtml(r.marca)}</td>
          <td>${new Date(r.horaIngreso).toLocaleString()}</td>
          <td>${r.horaSalida ? new Date(r.horaSalida).toLocaleString() : '-'}</td>
          <td>${r.total != null ? 'Q' + Number(r.total).toFixed(2) : '-'}</td>
          <td>
            ${r.horaSalida ? '' : `<button class="btn" data-idx="${idx}" data-action="salir">Salir</button>
            <button class="btn ghost" data-idx="${idx}" data-action="gym">GYM</button>`}
            <button class="btn ghost" data-idx="${idx}" data-action="ticket">Ticket</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      actualizarResumen();
      renderHistorial();
      save();
    }

    // Seguridad b√°sica para texto mostrado
    function escapeHtml(s){ return String(s || '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }

    // Eventos: Ingresar
    document.getElementById('btnIngresar').addEventListener('click', () => {
      const placaEl = document.getElementById('placa');
      const marcaEl = document.getElementById('marca');
      const placa = (placaEl.value || '').trim();
      const marca = (marcaEl.value || '').trim();
      if (!placa || !marca) return alert('Ingrese placa y marca');
      const hora = new Date().toISOString();
      registros.push({ id: uid('r'), placa, marca, horaIngreso: hora, horaSalida: null, total: null });
      placaEl.value = ''; marcaEl.value = '';
      placaEl.focus();
      imprimirTicket(placa, marca, hora);
      actualizarTabla();
    });

    // Bot√≥n GYM (Q0)
    document.getElementById('btnGym').addEventListener('click', () => {
      const placaEl = document.getElementById('placa');
      const marcaEl = document.getElementById('marca');
      const placa = (placaEl.value || '').trim();
      const marca = (marcaEl.value || '').trim();
      if (!placa || !marca) return alert('Ingrese placa y marca');
      const hora = new Date().toISOString();
      const rec = { id: uid('r'), placa, marca, horaIngreso: hora, horaSalida: new Date().toISOString(), total: 0 };
      registros.push(rec);
      placaEl.value = ''; marcaEl.value = '';
      imprimirFacturaGYM(rec);
      actualizarTabla();
    });

    // Delegation para acciones de botones dentro de la tabla
    document.getElementById('registro').addEventListener('click', (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;
      const idx = Number(btn.dataset.idx);
      const action = btn.dataset.action;
      if (action === 'salir') sacarVehiculo(idx);
      if (action === 'gym') marcarGYM(idx);
      if (action === 'ticket') imprimirTicketFromIndex(idx);
    });

    // Sacar veh√≠culo (salida normal)
    function sacarVehiculo(index){
      if (!registros[index]) return;
      const salida = new Date().toISOString();
      registros[index].horaSalida = salida;
      registros[index].total = calcularPago(registros[index].horaIngreso, salida);
      imprimirFactura(registros[index]);
      actualizarTabla();
    }

    function marcarGYM(index){
      if (!registros[index]) return;
      const salida = new Date().toISOString();
      registros[index].horaSalida = salida;
      registros[index].total = 0;
      imprimirFacturaGYM(registros[index]);
      actualizarTabla();
    }

    function imprimirTicketFromIndex(index){
      const r = registros[index];
      if (!r) return;
      imprimirTicket(r.placa, r.marca, r.horaIngreso);
    }

    // Impresi√≥n util
    function imprimirHTMLWindow(html, options = {}) {
      const w = window.open('', '_blank', 'width=380,height=640');
      if (!w) { alert('La ventana de impresi√≥n fue bloqueada por el navegador. Permite popups para este sitio.'); return; }
      w.document.write(html);
      w.document.close();
      if (!options.noPrint) setTimeout(()=>w.print(), 500);
    }

    // IMAGEN USADA EN TICKETS: IMAGEN1.png (aseg√∫rate que exista)
    const TICKET_IMG = 'IMAGEN1.png';

    function imprimirTicket(placa, marca, hora){
      const fecha = new Date(hora);
      const fechaStr = fecha.toLocaleDateString();
      const horaStr = fecha.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const barcodeURL = `https://barcode.tec-it.com/barcode.ashx?data=${encodeURIComponent(placa)}&code=Code128&translate-esc=false`;
      const html = `
      <html><head><meta charset="utf-8"><title>Ticket</title>
      <style>
        body{font-family:monospace;text-align:center;padding:10px;color:#000}
        .line{border-top:1px dashed #000;margin:10px 0}
        .big{font-size:18pt;font-weight:700}
        img.logo{max-width:220px;height:auto}
      </style></head><body>
        <img src="${TICKET_IMG}" class="logo" alt="logo" />
        <div class="line"></div>
        <div>FECHA</div><div>${fechaStr}</div>
        <div class="line"></div>
        <div>HORA DE INGRESO</div><div class="big">${horaStr}</div>
        <div class="line"></div>
        <div>PLACA</div><div class="big">${escapeHtml(placa)}</div>
        <div class="line"></div>
        <div>MARCA</div><div class="big">${escapeHtml(marca)}</div>
        <div class="line"></div>
        <div><img src="${barcodeURL}" class="barcode" alt="barcode"/></div>
        <div class="line"></div>
        <pre>Gracias por su visita\n*RECUERDE NO PERDER SU TICKET*</pre>
      </body></html>`;
      imprimirHTMLWindow(html);
    }

    function imprimirFactura(dato){
      const entrada = new Date(dato.horaIngreso);
      const salida = new Date(dato.horaSalida);
      const tiempo = Math.ceil((salida - entrada)/60000);
      const barcodeURL = `https://barcode.tec-it.com/barcode.ashx?data=${encodeURIComponent(dato.placa)}&code=Code128&translate-esc=false`;
      const html = `
      <html><head><meta charset="utf-8"><title>Factura</title>
      <style>
        body{font-family:monospace;text-align:center;padding:10px;color:#000}
        .line{border-top:1px dashed #000;margin:10px 0}
        .big{font-size:18pt;font-weight:700}
        img.logo{max-width:220px;height:auto}
      </style></head><body>
        <img src="${TICKET_IMG}" class="logo" alt="logo" />
        <div class="line"></div>
        <div>FACTURA VEH√çCULO</div>
        <div class="line"></div>
        <div>PLACA</div><div class="big">${escapeHtml(dato.placa)}</div>
        <div class="line"></div>
        <div>MARCA</div><div class="big">${escapeHtml(dato.marca)}</div>
        <div class="line"></div>
        <div>ENTRADA</div><div>${entrada.toLocaleString()}</div>
        <div class="line"></div>
        <div>SALIDA</div><div>${salida.toLocaleString()}</div>
        <div class="line"></div>
        <div>TIEMPO TOTAL</div><div class="big">${tiempo} minutos</div>
        <div class="line"></div>
        <div>TOTAL A PAGAR</div><div class="big">Q${Number(dato.total).toFixed(2)}</div>
        <div class="line"></div>
        <div><img src="${barcodeURL}" class="barcode" alt="barcode"/></div>
        <div class="line"></div>
        <pre>Gracias por su visita</pre>
      </body></html>`;
      imprimirHTMLWindow(html);
    }

    function imprimirFacturaGYM(dato){
      const entrada = new Date(dato.horaIngreso);
      const salida = new Date(dato.horaSalida);
      const tiempo = Math.ceil((salida - entrada)/60000);
      const barcodeURL = `https://barcode.tec-it.com/barcode.ashx?data=${encodeURIComponent(dato.placa)}&code=Code128&translate-esc=false`;
      const html = `
      <html><head><meta charset="utf-8"><title>Factura GYM</title>
      <style>
        body{font-family:monospace;text-align:center;padding:10px;color:#000}
        .line{border-top:1px dashed #000;margin:10px 0}
        .big{font-size:18pt;font-weight:700;color:#18833a}
        img.logo{max-width:220px;height:auto}
      </style></head><body>
        <img src="${TICKET_IMG}" class="logo" alt="logo" />
        <div class="line"></div>
        <div>FACTURA VEH√çCULO GYM üí™</div>
        <div class="line"></div>
        <div>PLACA</div><div class="big">${escapeHtml(dato.placa)}</div>
        <div class="line"></div>
        <div>MARCA</div><div class="big">${escapeHtml(dato.marca)}</div>
        <div class="line"></div>
        <div>ENTRADA</div><div>${entrada.toLocaleString()}</div>
        <div class="line"></div>
        <div>SALIDA</div><div>${salida.toLocaleString()}</div>
        <div class="line"></div>
        <div>TIEMPO TOTAL</div><div class="big">${tiempo} minutos</div>
        <div class="line"></div>
        <div>TOTAL A PAGAR</div><div class="big">Q0.00</div>
        <div class="line"></div>
        <div><img src="${barcodeURL}" class="barcode" alt="barcode"/></div>
        <div class="line"></div>
        <pre>Gracias por su visita\nPARQUEO PARA GYM</pre>
      </body></html>`;
      imprimirHTMLWindow(html);
    }

    // Resumen & Chart
    let chartInstance = null;
    function actualizarResumen() {
      const activos = registros.filter(r => !r.horaSalida).length;
      const total = registros.reduce((s,r) => s + (r.total || 0), 0);
      const hoy = registros.filter(r => new Date(r.horaIngreso).toDateString() === new Date().toDateString()).length;
      document.getElementById('statActivos').innerText = activos;
      document.getElementById('statTotal').innerText = 'Q' + total.toFixed(2);
      document.getElementById('statEntradas').innerText = hoy;
      renderChart();
    }

    function renderChart(){
      const ctx = document.getElementById('chart').getContext('2d');
      const buckets = {};
      registros.forEach(r => {
        const h = new Date(r.horaIngreso).getHours();
        buckets[h] = (buckets[h] || 0) + 1;
      });
      const labels = Array.from({length:24}, (_,i) => String(i).padStart(2,'0') + ':00');
      const data = labels.map(l => buckets[Number(l.slice(0,2))] || 0);
      if (chartInstance) chartInstance.destroy();
      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label: 'Entradas por hora', data, backgroundColor: 'rgba(6,182,212,0.85)' }] },
        options: { responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
      });
    }

    // Historial render
    function renderHistorial(){
      const tbody = document.getElementById('historial');
      tbody.innerHTML = '';
      registros.forEach((r, i) => {
        const minutos = r.horaSalida ? Math.ceil((new Date(r.horaSalida) - new Date(r.horaIngreso))/60000) : '-';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${escapeHtml(r.placa)}</td>
          <td>${escapeHtml(r.marca)}</td>
          <td>${new Date(r.horaIngreso).toLocaleString()}</td>
          <td>${r.horaSalida ? new Date(r.horaSalida).toLocaleString() : '-'}</td>
          <td>${minutos}</td>
          <td>${r.total != null ? 'Q' + Number(r.total).toFixed(2) : '-'}</td>
          <td><button class="btn" data-idx="${i}" data-action="view">Ver</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Export / Import handlers
    document.getElementById('exportJSON')?.addEventListener('click', () => {
      try {
        const blob = new Blob([JSON.stringify(registros, null, 2)], { type: 'application/json' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = 'parqueo_backup_' + (new Date()).toISOString().slice(0,10) + '.json'; a.click();
      } catch (e) { alert('Error exportando JSON'); console.error(e); }
    });

    document.getElementById('importJSONBtn')?.addEventListener('click', () => document.getElementById('fileImport').click());
    document.getElementById('fileImport')?.addEventListener('change', (e) => {
      const f = e.target.files[0]; if (!f) return;
      const r = new FileReader();
      r.onload = () => {
        try {
          const data = JSON.parse(r.result);
          if (!Array.isArray(data)) return alert('Archivo inv√°lido');
          if (confirm('¬øReemplazar registros actuales con este backup? (Aceptar = reemplazar)')) {
            registros = data;
          } else {
            registros = registros.concat(data);
          }
          save(); actualizarTabla(); alert('Importaci√≥n completada');
        } catch (err) { alert('Error al leer archivo'); console.error(err); }
      };
      r.readAsText(f);
    });

    // Export CSV
    document.getElementById('btnExportCSV')?.addEventListener('click', () => {
      try {
        const rows = [['placa','marca','horaIngreso','horaSalida','total']];
        registros.forEach(r => rows.push([r.placa, r.marca, r.horaIngreso, r.horaSalida || '', r.total || 0]));
        const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
        const blob = new Blob([csv], { type:'text/csv' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = 'parqueo_' + (new Date()).toISOString().slice(0,10) + '.csv'; a.click();
      } catch(e){ alert('Error generando CSV'); console.error(e); }
    });

    // Clear all
    document.getElementById('btnClearAll')?.addEventListener('click', () => {
      if (!confirm('Borrar todos los registros actuales?')) return;
      registros = []; save(); actualizarTabla();
    });

    // Print summary
    document.getElementById('btnPrintSummary')?.addEventListener('click', () => {
      const total = registros.reduce((s,r) => s + (r.total || 0), 0);
      const html = `<html><body style="font-family:monospace;text-align:center"><h2>CIERRE DE TURNO</h2><pre>TOTAL: Q${total.toFixed(2)}</pre></body></html>`;
      const w = window.open('','_blank'); if (!w) return alert('Permite popups para imprimir.');
      w.document.write(html); w.document.close(); setTimeout(()=>w.print(),300);
    });

    // Search filter
    document.getElementById('search').addEventListener('input', function(){
      const q = this.value.trim().toLowerCase();
      const tbody = document.getElementById('registro');
      Array.from(tbody.children).forEach(tr => {
        const placa = (tr.children[0]?.innerText || '').toLowerCase();
        const marca = (tr.children[1]?.innerText || '').toLowerCase();
        tr.style.display = (placa.includes(q) || marca.includes(q)) ? '' : 'none';
      });
    });

    // Menu navigation
    document.getElementById('menu').addEventListener('click', (e) => {
      const b = e.target.closest('button');
      if (!b) return;
      document.querySelectorAll('#menu button').forEach(x => x.classList.remove('active'));
      b.classList.add('active');
      const view = b.dataset.view;
      document.querySelectorAll('.view').forEach(v => v.style.display = (v.id === 'view-' + view) ? '' : 'none');
    });

    // Historial view detail button
    document.getElementById('historial')?.addEventListener('click', (e) => {
      const btn = e.target.closest('button'); if (!btn) return;
      const idx = Number(btn.dataset.idx); const action = btn.dataset.action;
      if (action === 'view') {
        const r = registros[idx];
        alert(`Placa: ${r.placa}\nMarca: ${r.marca}\nIngreso: ${new Date(r.horaIngreso).toLocaleString()}\nSalida: ${r.horaSalida ? new Date(r.horaSalida).toLocaleString() : '-'}\nTotal: ${r.total != null ? 'Q' + Number(r.total).toFixed(2) : '-'}`);
      }
    });

    // Support enter key for quick input
    document.getElementById('placa').addEventListener('keyup', (e) => { if (e.key === 'Enter') document.getElementById('marca').focus(); });
    document.getElementById('marca').addEventListener('keyup', (e) => { if (e.key === 'Enter') document.getElementById('btnIngresar').click(); });

    // Inicializaci√≥n
    function init(){
      actualizarTabla();
      document.querySelector('#menu button[data-view="dashboard"]').click();
    }
    init();

    // Restaurar tarifas (mensaje informativo)
    document.getElementById('btnResetTarifas')?.addEventListener('click', () => {
      if (confirm('¬øRestaurar tarifas originales (no modifica registros) ?')) {
        alert('Las tarifas originales se mantienen por defecto.');
      }
    });

    // Exponer en consola para debugging
    window.PP = { registros, save, calcularPago, tarifas };

  </script>
</body>
</html>


<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Sistema Offline - Las Piconas (Touch) - V6</title>
<style>
:root{
  --bg:#0b0f14;--panel:#0f1720;--card:#0b1220;--accent:#ff6b35;--muted:#9aa4b2;--glass:rgba(255,255,255,0.03);
  --green: #28a745;
}
*{box-sizing:border-box;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif;}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#06080a 0%, #0b0f14 100%);color:#e6eef6;}
.app{display:grid;grid-template-columns:360px 1fr 360px;gap:14px;padding:14px;height:100vh;}
.sidebar{background:var(--panel);border-radius:12px;padding:12px;display:flex;flex-direction:column;box-shadow:0 6px 18px rgba(2,6,23,0.6);}
.brand{font-weight:800;letter-spacing:0.6px;padding:8px 12px;font-size:18px;text-align:center;color:#fff;}
.logo-preview{max-width:140px;margin:6px auto 8px;display:block;}
.controls-row{display:flex;gap:8px;margin-bottom:8px;}
.input, .qty{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:10px;border-radius:8px;color:#e6eef6;}
.categorias{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;}
.cat-item{display:flex;align-items:center;gap:6px;background:rgba(255,255,255,0.02);padding:6px;border-radius:8px;}
.cat-btn{padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);cursor:pointer;font-weight:700;min-width:80px;background:transparent;color:#fff;}
.cat-actions{display:flex;gap:4px;}
.products{margin-top:12px;display:grid;grid-template-columns:repeat(3,1fr);gap:10px;overflow:auto;padding:6px;height:calc(100vh - 420px);}
.prod-card{position:relative;padding:12px;border-radius:10px;cursor:pointer;text-align:center;user-select:none;color:#fff;border:1px solid rgba(255,255,255,0.04);}
.prod-name{font-weight:800;}
.prod-price{font-size:13px;color:var(--muted);margin-top:6px;}
.prod-actions{position:absolute;top:6px;right:6px;display:flex;gap:4px;}
.action-small{background:rgba(0,0,0,0.2);border:none;color:#fff;padding:4px 6px;border-radius:6px;cursor:pointer;font-size:12px;}
.center{background:var(--card);border-radius:12px;padding:12px;display:flex;flex-direction:column;box-shadow:0 6px 18px rgba(2,6,23,0.6);}
.viewer{flex:1;background:linear-gradient(180deg,#071428,#071a2a);padding:12px;border-radius:10px;overflow:auto;}
.item-row{display:flex;justify-content:space-between;align-items:center;gap:8px;padding:8px;border-bottom:1px dashed rgba(255,255,255,0.03);}
.item-actions{display:flex;gap:6px;}
.action-btn{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff;padding:6px 8px;border-radius:8px;cursor:pointer;}
.controls{display:flex;gap:8px;margin-top:10px;}
.control-btn{flex:1;padding:12px;border-radius:8px;background:var(--accent);color:#0b1220;font-weight:800;border:none;cursor:pointer;}
.small{padding:8px;font-size:14px;}
.right{background:var(--panel);border-radius:12px;padding:12px;display:flex;flex-direction:column;box-shadow:0 6px 18px rgba(2,6,23,0.6);}
.summary{background:linear-gradient(180deg,#071428,#071a2a);border-radius:10px;padding:12px;margin-bottom:12px;}
.kv{display:flex;justify-content:space-between;color:var(--muted);padding:6px 0;}
.history{flex:1;overflow:auto;}
.row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;margin-bottom:8px;background:rgba(255,255,255,0.02);}
.footer{font-size:12px;color:var(--muted);text-align:center;margin-top:8px;}
.big-btn{background:linear-gradient(90deg,#111827,#0b1220);border:2px solid rgba(255,255,255,0.04);color:#fff;padding:12px;border-radius:10px;font-weight:800;}
.topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
.current-order{font-size:20px;font-weight:900;text-align:center;}
@media print{body *{visibility:hidden}.print-area, .print-area *{visibility:visible}.print-area{position:fixed;left:0;top:0;width:100%}}
.login-wrap{position:fixed;inset:0;background:linear-gradient(90deg, rgba(2,6,23,0.9), rgba(4,10,27,0.95));display:flex;align-items:center;justify-content:center;z-index:999;}
.login-card{background:linear-gradient(180deg,#071428,#0b1220);padding:28px;border-radius:12px;min-width:360px;box-shadow:0 8px 30px rgba(2,6,23,0.7);color:#fff;}
.login-card h2{text-align:center;margin:6px 0 12px;}
.login-card .input{width:100%;margin-bottom:10px;}
.login-logo{max-width:140px;display:block;margin:0 auto 10px;}
.pay-active{outline:2px solid rgba(255,255,255,0.08);box-shadow:0 4px 12px rgba(0,0,0,0.4) inset;}
.comment-input{background:transparent;border:1px dashed rgba(255,255,255,0.04);padding:6px;border-radius:6px;color:#e6eef6;font-size:13px;min-width:140px}

/* cobrar top but hidden until login */
#btnCobrarTop { position:fixed; top:12px; left:50%; transform:translateX(-50%); z-index:1000; background:var(--green); color:#fff; border:none; padding:14px 28px; border-radius:12px; font-weight:900; font-size:18px; box-shadow:0 8px 20px rgba(0,0,0,0.35); cursor:pointer; display:none; }

/* change order button near totals */
#btnChangeOrder { background:#0b1220;color:#fff;border:1px solid rgba(255,255,255,0.06);padding:8px;border-radius:8px;font-weight:800;cursor:pointer;margin-top:8px; }

/* category/product color visual */
.cat-btn.colored, .prod-card.colored { color: #fff; }
</style>
</head>
<body>

<!-- COBRAR grande arriba (hidden until login) -->

<!-- Men√∫ hamburguesa (solo visible tras login) -->
<button id="menuHamburguesa" title="Men√∫" style="display:none;position:fixed;top:12px;left:12px;z-index:1001;background:#111;border:none;color:white;font-size:26px;padding:6px 12px;border-radius:8px;cursor:pointer;">‚ò∞</button>
<div id="menuLateral" style="position:fixed;top:0;left:-260px;width:240px;height:100%;background:#111827;color:white;z-index:1000;padding-top:60px;transition:left 0.3s;">
  <a href="#" data-action="addCat" style="display:block;padding:10px 14px;color:white;text-decoration:none;">‚ûï Crear Categor√≠a</a>
  <a href="#" data-action="editCat" style="display:block;padding:10px 14px;color:white;text-decoration:none;">‚úèÔ∏è Modificar Categor√≠a</a>
  <a href="#" data-action="delCat" style="display:block;padding:10px 14px;color:white;text-decoration:none;">‚ùå Eliminar Categor√≠a</a>
  <a href="#" data-action="addProd" style="display:block;padding:10px 14px;color:white;text-decoration:none;">‚ûï Crear Producto</a>
  <a href="#" data-action="editProd" style="display:block;padding:10px 14px;color:white;text-decoration:none;">‚úèÔ∏è Modificar Producto</a>
  <a href="#" data-action="delProd" style="display:block;padding:10px 14px;color:white;text-decoration:none;">‚ùå Eliminar Producto</a>
</div>

<button id="btnCobrarTop" title="Cobrar">COBRAR üíµ</button>

<!-- LOGIN -->
<div id="login" class="login-wrap">
  <div class="login-card">
    <img src="logo" class="login-logo" onerror="this.onerror=null;this.src='logo.png';" />
    <h2>Ingreso al Sistema</h2>
    <input id="user" class="input" placeholder="Usuario" value="" />
    <input id="pass" class="input" placeholder="Clave" type="password" />
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="btnLogin" class="big-btn" style="flex:1">Entrar</button>
    </div>
    <div style="text-align:center;margin-top:10px;color:var(--muted);font-size:13px">
      Usuario: <b>CAJERO</b> ‚Äî Clave: <b>123</b>
    </div>
  </div>
</div>

<div class="app" id="appRoot" style="display:none;">
  <div class="sidebar">
    <div class="brand">Las Piconas - Punto de Venta (Touch)</div>
    <img src="logo" alt="logo" class="logo-preview" onerror="this.onerror=null;this.src='logo.png';" />

    <div style="margin-top:12px">
      <button id="btnAddCategory" class="big-btn" style="margin-bottom:6px">+ Nueva Categor√≠a</button>
      <button id="btnAddProduct" class="big-btn">+ Nuevo Producto</button>
    </div>

    <div class="controls-row">
      <input id="qty" class="qty" type="number" value="1" min="1" style="flex:1" />
      <button id="btnDeleteLast" class="action-btn">Borrar √∫ltimo</button>
    </div>

    <div style="margin-top:6px">
      <div style="font-size:13px;color:var(--muted);padding:6px">Categor√≠as</div>
      <div class="categorias" id="categorias"></div>
    </div>

    <div style="margin-top:12px">
      <div style="font-size:13px;color:var(--muted);padding:6px">Productos</div>
      <div class="products" id="products"></div>
    </div>
  </div>

  <div class="center" style="padding-top:68px;">
    <div class="topbar">
      <div style="font-weight:800;font-size:18px">Visor de Cliente</div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="btn-cash" class="action-btn">Efectivo</button>
        <button id="btn-card" class="action-btn">Tarjeta</button>
        <input id="generalComment" placeholder="Comentario general (opcional)" class="input" style="width:260px;margin-left:8px" />
      </div>
    </div>
    <div class="current-order" id="currentOrder">Orden: A 1</div>
    <div class="viewer" id="viewer"></div>
    <div class="controls">
      <button id="minus" class="action-btn small">-</button>
      <button id="plus" class="action-btn small">+</button>
      <button id="coupon" class="action-btn small">Descuento Q</button>
      <button id="finalizar" class="control-btn">Cobrar & Generar Tickets</button>
    </div>
  </div>

  <div class="right">
    <div class="summary">
      <div class="kv"><div>Subtotal</div><div id="subtotal">Q0.00</div></div>
      <div class="kv"><div>Descuento</div><div id="discount">Q0.00</div></div>
      <div class="kv" style="font-weight:800;margin-top:8px"><div>Total</div><div id="total">Q0.00</div></div>
      <button id="btnChangeOrder">Cambiar n√∫mero de orden</button>
    </div>

    <div style="margin-bottom:8px">
      <div style="font-size:13px;color:var(--muted);margin-bottom:6px">Historial / Reimprimir</div>
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <input id="searchId" class="input" placeholder="Buscar por id u orden..." />
        <button id="btnSearch" class="action-btn">Buscar</button>
      </div>
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <button id="btnCloseShift" class="big-btn" style="flex:1;background:linear-gradient(90deg,#7c3aed,#6d28d9)">Cierre de Turno</button>
        <button id="btnExport" class="action-btn">Exportar</button>
      </div>
      <div class="history" id="history"></div>
    </div>
    <div class="footer">Powered by Marck Business - Tecnolog√≠a para tu negocio</div>
  </div>
</div>

<script>
// ================= INITIAL DATA & BACKWARDS COMPATIBILITY =================
let rawCategories = localStorage.getItem('categories_v3');
let CATEGORIES;
if(rawCategories){
  try{
    CATEGORIES = JSON.parse(rawCategories);
    // if the structure is legacy (cat: [products]), convert to { color: '#...?', products: [...] }
    Object.keys(CATEGORIES).forEach(cat=>{
      if(Array.isArray(CATEGORIES[cat])){
        CATEGORIES[cat] = { color: '#2a2f36', products: CATEGORIES[cat] };
      } else if(CATEGORIES[cat] && CATEGORIES[cat].products && Array.isArray(CATEGORIES[cat].products)){
        // ok
      } else {
        // fallback
        CATEGORIES[cat] = { color: '#2a2f36', products: []};
      }
    });
  }catch(e){
    // corrupt -> set default
    CATEGORIES = {
      'MEDIANAS': { color:'#0f4bff', products:[{name:'MED. POLLO', price:35},{name:'MED. PASTOR', price:35}]},
      'JUMBOS': { color:'#16a34a', products:[{name:'JUMB. POLLO', price:55}]}
    };
  }
} else {
  CATEGORIES = {
    'MEDIANAS': { color:'#0f4bff', products:[{name:'MED. POLLO', price:35},{name:'MED. PASTOR', price:35},{name:'MED. MIXTA', price:35}]},
    'JUMBOS': { color:'#16a34a', products:[{name:'JUMB. POLLO', price:55},{name:'JUMB. PASTOR', price:55}]},
    'TACOS': { color:'#7c3aed', products:[{name:'TACOS POLLO', price:35},{name:'TACOS PASTOR', price:35}]},
    'BEBIDAS': { color:'#f97316', products:[{name:'AGUA PURA', price:10},{name:'COCA COLA', price:15}]},
    'POSTRES_Y_EXTRAS': { color:'#ef4444', products:[{name:'CINAMON ROLL', price:20},{name:'ARROZ EN LECHE', price:20}]}
  };
}

let cart = JSON.parse(localStorage.getItem('current_cart_working')||'[]') || [];
let discount = 0;
let paymentMethod = 'EFECTIVO';
let orderCounter = Number(localStorage.getItem('order_counter') || 1);

// =============== HELPERS =================
function persistCategories(){ localStorage.setItem('categories_v3', JSON.stringify(CATEGORIES)); broadcastState('categories_v3', JSON.stringify(CATEGORIES)); }
function persistWorkingCart(){ localStorage.setItem('current_cart_working', JSON.stringify(cart)); broadcastState('current_cart_working', JSON.stringify(cart)); }
function fmt(v){ return 'Q'+(Number(v)||0).toFixed(2); }
function escapeHtml(s){ if(!s && s!==0) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function pad(n){ return n<10 ? '0'+n : n; }
function formatDateTime(d){ return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`; }
function broadcastState(key,value){ try{ localStorage.setItem(key,value); }catch(e){} }

// =============== UI RENDER =================
function updateCurrentOrderUI(){ document.getElementById('currentOrder').textContent = 'Orden: A ' + orderCounter; }
function recalc(){ const subtotal = cart.reduce((s,i)=>s + i.price*i.qty,0); const total = Math.max(0, subtotal - discount); document.getElementById('subtotal').textContent = fmt(subtotal); document.getElementById('discount').textContent = fmt(discount); document.getElementById('total').textContent = fmt(total); }

function renderCategories(){
  const el = document.getElementById('categorias'); el.innerHTML='';
  Object.keys(CATEGORIES).forEach(cat=>{
    const meta = CATEGORIES[cat];
    const div = document.createElement('div'); div.className='cat-item';
    const b = document.createElement('button'); b.className='cat-btn'; b.textContent = cat;
    if(meta && meta.color){ b.style.background = meta.color; b.classList.add('colored'); }
    b.onclick = ()=> showProducts(cat);
    const actions = document.createElement('div'); actions.className='cat-actions';
    const editBtn = document.createElement('button'); editBtn.className='action-small'; editBtn.textContent='‚úèÔ∏è'; editBtn.title='Editar';
    editBtn.onclick = (e)=>{ e.stopPropagation(); editCategory(cat); };
    const delBtn = document.createElement('button'); delBtn.className='action-small'; delBtn.textContent='üóëÔ∏è'; delBtn.title='Eliminar';
    delBtn.onclick = (e)=>{ e.stopPropagation(); deleteCategory(cat); };
    actions.appendChild(editBtn); actions.appendChild(delBtn);
    div.appendChild(b); div.appendChild(actions);
    el.appendChild(div);
  });
}

function showProducts(cat){
  const el = document.getElementById('products'); el.innerHTML='';
  const meta = CATEGORIES[cat];
  if(!meta || !Array.isArray(meta.products)) return;
  meta.products.forEach((p, idx)=>{
    const card = document.createElement('div'); card.className='prod-card';
    card.onclick = ()=> addProductWithCommentPrompt(p);
    if(meta.color){ card.style.background = meta.color; card.classList.add('colored'); }
    card.innerHTML = `<div class='prod-name'>${p.name}</div><div class='prod-price'>${fmt(p.price)}</div>`;
    const actions = document.createElement('div'); actions.className='prod-actions';
    const editBtn = document.createElement('button'); editBtn.className='action-small'; editBtn.textContent='‚úèÔ∏è'; editBtn.title='Editar';
    editBtn.onclick = (e)=>{ e.stopPropagation(); editProduct(cat, idx); };
    const delBtn = document.createElement('button'); delBtn.className='action-small'; delBtn.textContent='üóëÔ∏è'; delBtn.title='Eliminar';
    delBtn.onclick = (e)=>{ e.stopPropagation(); deleteProduct(cat, idx); };
    actions.appendChild(editBtn); actions.appendChild(delBtn);
    card.appendChild(actions);
    el.appendChild(card);
  });
}

function renderViewer(){
  updateCurrentOrderUI();
  const v = document.getElementById('viewer'); v.innerHTML='';
  cart.forEach((it,i)=>{
    const row = document.createElement('div'); row.className='item-row';
    const left = document.createElement('div'); left.style.flex='1';
    left.innerHTML = `<div style="font-weight:800">${it.qty} x ${escapeHtml(it.name)}</div>`;
    const commentInput = document.createElement('input');
    commentInput.className = 'comment-input';
    commentInput.placeholder = 'Comentario (ej. sin cebolla)';
    commentInput.value = it.comment || '';
    commentInput.addEventListener('input', (e)=>{ cart[i].comment = e.target.value; persistWorkingCart(); broadcastState('current_cart_working', JSON.stringify(cart)); });
    left.appendChild(commentInput);
    const right = document.createElement('div'); right.style.width='160px'; right.style.textAlign='right';
    right.innerHTML = `${fmt(it.price*it.qty)}<div style="margin-top:6px;display:flex;gap:6px;justify-content:flex-end"><button class="action-btn" data-idx="${i}" data-act="minus">-</button><button class="action-btn" data-idx="${i}" data-act="plus">+</button><button class="action-btn" style="background:#e74c3c" data-idx="${i}" data-act="del">X</button></div>`;
    row.appendChild(left); row.appendChild(right); v.appendChild(row);
  });
  Array.from(document.querySelectorAll('button[data-act]')).forEach(btn=>{
    btn.onclick = ()=> {
      const idx = Number(btn.getAttribute('data-idx'));
      const act = btn.getAttribute('data-act');
      if(act === 'minus'){ if(cart[idx].qty>1) cart[idx].qty--; else cart.splice(idx,1); }
      else if(act === 'plus'){ cart[idx].qty++; }
      else if(act === 'del'){ cart.splice(idx,1); }
      persistWorkingCart(); broadcastState('current_cart_working', JSON.stringify(cart)); renderViewer();
    };
  });
  recalc();
}

// ============== CRUD for categories & products with color support ==============
function addCategory(){
  const name = prompt('Nombre de la nueva categor√≠a:');
  if(!name) return;
  if(CATEGORIES[name]){ alert('Categor√≠a ya existe'); return; }
  const color = prompt('Color (HEX) para la categor√≠a (ej: #ff6b35):', '#2a2f36') || '#2a2f36';
  CATEGORIES[name] = { color: color, products: [] };
  persistCategories(); renderCategories();
}
function editCategory(oldName){
  const meta = CATEGORIES[oldName];
  const newName = prompt('Nuevo nombre para la categor√≠a:', oldName);
  if(!newName) return;
  const color = prompt('Nuevo color (HEX):', meta.color || '#2a2f36') || (meta.color || '#2a2f36');
  if(newName !== oldName){
    if(CATEGORIES[newName]){ alert('Ya existe categor√≠a con ese nombre'); return; }
    CATEGORIES[newName] = { color, products: meta.products };
    delete CATEGORIES[oldName];
  } else {
    CATEGORIES[oldName].color = color;
  }
  persistCategories(); renderCategories(); showProducts(newName);
}
function deleteCategory(cat){
  if(!confirm(`Eliminar la categor√≠a "${cat}" y todos sus productos?`)) return;
  delete CATEGORIES[cat];
  persistCategories(); renderCategories(); document.getElementById('products').innerHTML='';
  broadcastState('categories_v3', JSON.stringify(CATEGORIES));
}

function addProduct(){
  const cat = prompt('Categor√≠a del producto:');
  if(!cat) return alert('Ingrese categor√≠a');
  if(!CATEGORIES[cat]) return alert('Categor√≠a no existe');
  const name = prompt('Nombre del producto:');
  if(!name) return alert('Ingrese nombre');
  const price = parseFloat(prompt('Precio del producto:'));
  if(isNaN(price)) return alert('Precio inv√°lido');
  const color = prompt('Color (HEX) espec√≠fico del producto (opcional):', CATEGORIES[cat].color || '#2a2f36') || CATEGORIES[cat].color || '#2a2f36';
  CATEGORIES[cat].products.push({ name, price, color });
  persistCategories(); showProducts(cat); broadcastState('categories_v3', JSON.stringify(CATEGORIES));
}
function editProduct(cat, idx){
  const prod = CATEGORIES[cat].products[idx];
  const newName = prompt('Nuevo nombre del producto:', prod.name);
  if(!newName) return;
  const newPrice = parseFloat(prompt('Nuevo precio:', prod.price));
  if(isNaN(newPrice)) return alert('Precio inv√°lido');
  const newColor = prompt('Nuevo color (HEX) del producto:', prod.color || CATEGORIES[cat].color || '#2a2f36') || prod.color || CATEGORIES[cat].color || '#2a2f36';
  CATEGORIES[cat].products[idx] = { name: newName, price: newPrice, color: newColor };
  persistCategories(); showProducts(cat); broadcastState('categories_v3', JSON.stringify(CATEGORIES));
}
function deleteProduct(cat, idx){
  if(!confirm('Eliminar producto?')) return;
  CATEGORIES[cat].products.splice(idx,1);
  persistCategories(); showProducts(cat); broadcastState('categories_v3', JSON.stringify(CATEGORIES));
}

// ============== CART operations ==============
function addProductWithCommentPrompt(p){
  const qty = Number(document.getElementById('qty').value) || 1;
  const comment = ''; 
  const existing = cart.find(c => c.name === p.name && (c.comment || '') === comment && c.price === p.price);
  if(existing) existing.qty += qty;
  else cart.push({ name: p.name, price: p.price, qty, comment });
  persistWorkingCart(); renderViewer(); broadcastState('current_cart_working', JSON.stringify(cart));
}

// ============== Payment & print logic (combined, page-break between tickets) ==============
function buildSaleObject(){
  const idCompact = 'A'+orderCounter;
  const idLabel = 'A ' + orderCounter;
  const dateObj = new Date();
  const dateStr = formatDateTime(dateObj);
  const subtotal = cart.reduce((s,i)=>s+i.qty*i.price,0);
  const total = Math.max(0, subtotal - discount);
  const generalComment = (document.getElementById('generalComment')||{value:''}).value || '';
  return {
    id: idCompact,
    label: idLabel,
    date: dateObj.toISOString(),
    dateFormatted: dateStr,
    items: cart.map(i=>({ name:i.name, qty:i.qty, price:i.price, comment:i.comment||''})),
    subtotal, discount, total,
    method: paymentMethod,
    generalComment
  };
}

function generateCombinedHTML(ticket){
  const logoSrc = 'logo';
  const chefLogo = 'cocina.png';
  const client = `
    <div class="ticket client">
      <img src="${logoSrc}" class="logo" onerror="this.onerror=null;this.src='logo.png';" />
      <div style="text-align:center;font-weight:900;font-size:18px">TORTILLAS DE HARINA LAS PICONAS</div>
      <div style="text-align:center;font-size:12px">EVENTOS - ZONA 17, ROOSEVELT Y SAN CRISTOBAL</div>
      <div style="text-align:center;margin-top:6px">${escapeHtml(ticket.dateFormatted)}</div>
      <div style="text-align:center;font-size:22px;font-weight:900;margin:8px 0">ORDEN &nbsp; <span style="font-size:32px">${escapeHtml(ticket.label)}</span></div>
      <div style="font-size:16px;font-weight:700;text-align:center;margin-bottom:6px">DETALLE DE CONSUMO</div>
      <table style="width:100%;font-size:15px;border-collapse:collapse">
        <thead><tr><th style="width:70%;text-align:left">PRODUCTO</th><th style="text-align:right">PRECIO</th></tr></thead>
        <tbody>
          ${ticket.items.map(it=>`<tr><td style="padding:6px 0">${it.qty} x ${escapeHtml(it.name)}${it.comment?`<div style="font-size:13px;color:#333">(${escapeHtml(it.comment)})</div>`:''}</td><td style="text-align:right">${fmt(it.price*it.qty)}</td></tr>`).join('')}
        </tbody>
      </table>
      <div style="margin-top:8px;font-size:15px"><strong>SUBTOTAL:</strong> ${fmt(ticket.subtotal)}</div>
      <div style="font-size:15px"><strong>DESCUENTO:</strong> ${fmt(ticket.discount)}</div>
      <div style="font-size:20px;font-weight:900;margin-top:6px">TOTAL: ${fmt(ticket.total)}</div>
      <div style="margin-top:6px;font-size:13px">Forma de pago: ${escapeHtml(ticket.method)}</div>
      ${ticket.generalComment? `<div style="margin-top:6px;font-size:13px">Comentario: ${escapeHtml(ticket.generalComment)}</div>` : ''}
      <div style="text-align:center;margin-top:12px;font-size:13px">Gracias por su compra</div>
    </div>
  `;
  const kitchen = `
    <div class="ticket kitchen">
      <div style="text-align:center"><img src="${chefLogo}" class="chefLogo" onerror="this.onerror=null;this.src='cocina.png';" /></div>
      <div style="text-align:center;font-weight:900;font-size:18px;margin-top:4px">COCINA - COMANDA</div>
      <div style="text-align:center;font-size:12px">${escapeHtml(ticket.dateFormatted)}</div>
      <div style="text-align:center;font-size:24px;font-weight:900;margin:8px 0">ORDEN NO. ${escapeHtml(ticket.label)}</div>
      ${ticket.generalComment? `<div style="font-size:13px;color:#333;margin-bottom:6px;text-align:center">Comentario general: ${escapeHtml(ticket.generalComment)}</div>` : ''}
      <div style="margin-top:6px">
        ${ticket.items.map(it=>`<div style="font-size:16px;margin-bottom:6px"><strong>${it.qty} x ${escapeHtml(it.name)}</strong>${it.comment?`<div style="color:#b00;font-size:14px; margin-left:6px">(${escapeHtml(it.comment)})</div>`:''}</div>`).join('')}
      </div>
      <div style="text-align:center;margin-top:10px;font-size:12px">--- FIN COMANDA ---</div>
    </div>
  `;
  return `<!doctype html><html><head><meta charset="utf-8"><title>Tickets ${escapeHtml(ticket.id)}</title>
    <style>
      @media print { @page { size: 80mm auto; margin: 3mm; } body{ -webkit-print-color-adjust: exact; margin:0; } .page-break{page-break-after:always;break-after:page;} }
      body{font-family:Arial,Helvetica,sans-serif;padding:6px;margin:0;}
      .ticket{width:76mm;margin:0 auto;font-size:15px;padding-bottom:6px;}
      img.logo{max-width:72mm;height:auto;display:block;margin:0 auto 6px;}
      img.chefLogo{max-width:60mm;height:auto;display:block;margin:0 auto 6px;}
    </style>
  </head><body onload="setTimeout(()=>{ window.print(); },200)">
    ${client}
    <div class="page-break"></div>
    ${kitchen}
  </body></html>`;
}

function finalizeSale(){
  if(cart.length === 0){ alert('No hay productos'); return; }
  const sale = buildSaleObject();
  saveSale(sale);
  const html = generateCombinedHTML(sale);
  const w = window.open('', '_blank', 'width=420,height=900');
  if(!w){ alert('El navegador bloque√≥ la ventana de impresi√≥n. Permite pop-ups y vuelve a intentar.'); return; }
  w.document.open(); w.document.write(html); w.document.close();
  // cleanup
  cart = []; discount = 0; persistWorkingCart(); broadcastState('current_cart_working', JSON.stringify(cart));
  orderCounter = Number(orderCounter) + 1; localStorage.setItem('order_counter', orderCounter); broadcastState('order_counter', String(orderCounter));
  renderViewer(); renderHistory();
  setTimeout(()=> alert('Venta registrada y tickets enviados a impresi√≥n.'), 500);
}

// ============== SALES STORAGE & HISTORY =================
function saveSale(sale){
  const hist = JSON.parse(localStorage.getItem('sales_v3')||'[]');
  hist.push(sale);
  localStorage.setItem('sales_v3', JSON.stringify(hist));
  broadcastState('sales_v3', JSON.stringify(hist));
  localStorage.setItem('last_sale_id', sale.id);
  broadcastState('last_sale_id', sale.id);
}

function renderHistory(filter){
  const hist = JSON.parse(localStorage.getItem('sales_v3')||'[]');
  const el = document.getElementById('history'); el.innerHTML='';
  const list = (filter? hist.filter(h=> (h.id||'').toString().includes(filter) || (h.label||'').toString().includes(filter) ) : hist).slice().reverse();
  if(list.length===0){ el.innerHTML = '<div style="color:var(--muted);padding:8px">No hay ventas a√∫n</div>'; return; }
  list.forEach(h=>{
    const div = document.createElement('div'); div.className='row';
    const left = document.createElement('div');
    left.innerHTML = `#${h.label} - <b>${fmt(h.total)}</b> (${escapeHtml(h.method)})<div style="font-size:12px;color:var(--muted)">${escapeHtml(h.dateFormatted)}</div>`;
    const right = document.createElement('div');
    const btn1 = document.createElement('button'); btn1.className='action-btn'; btn1.textContent='Reimprimir Venta';
    const btn2 = document.createElement('button'); btn2.className='action-btn'; btn2.textContent='Reimprimir Cocina';
    const btn3 = document.createElement('button'); btn3.className='action-btn'; btn3.textContent='Detalles';
    btn1.onclick = (e)=>{ e.stopPropagation(); printSaleOnly(h); };
    btn2.onclick = (e)=>{ e.stopPropagation(); printKitchenOnly(h); };
    btn3.onclick = (e)=>{ e.stopPropagation(); openDetailModal(h); };
    right.appendChild(btn1); right.appendChild(btn2); right.appendChild(btn3);
    div.appendChild(left); div.appendChild(right);
    el.appendChild(div);
  });
}
function printSaleOnly(ticket){
  const combined = generateCombinedHTML(ticket);
  // extract only client part (before page-break)
  const parts = combined.split('<div class="page-break"></div>');
  const html = parts[0] + '</body></html>';
  const w = window.open('', '_blank', 'width=420,height=720'); if(!w) return alert('Bloqueador de ventanas'); w.document.open(); w.document.write(html); w.document.close(); setTimeout(()=>{ try{ w.print(); }catch(e){} },200);
}
function printKitchenOnly(ticket){
  const combined = generateCombinedHTML(ticket);
  const parts = combined.split('<div class="page-break"></div>');
  const html = '<!doctype html><html><head><meta charset="utf-8"><title>Comanda</title></head><body>' + parts[1] + '</body></html>';
  const w = window.open('', '_blank', 'width=420,height=720'); if(!w) return alert('Bloqueador de ventanas'); w.document.open(); w.document.write(html); w.document.close(); setTimeout(()=>{ try{ w.print(); }catch(e){} },200);
}

function openDetailModal(ticket){
  const w = window.open('', '_blank', 'width=480,height=640');
  let html = `<html><head><meta charset="utf-8"><title>Detalle ${escapeHtml(ticket.label)}</title></head><body style="font-family:Arial;padding:12px">`;
  html += `<h3>Detalle ${escapeHtml(ticket.label)}</h3>`;
  html += `<div>Fecha: ${escapeHtml(ticket.dateFormatted)}</div>`;
  html += `<div>Forma: ${escapeHtml(ticket.method)}</div>`;
  html += `<div>Comentario: ${escapeHtml(ticket.generalComment || '')}</div>`;
  html += `<ul>`;
  ticket.items.forEach(it => { html += `<li>${it.qty} x ${escapeHtml(it.name)} - Q${(it.price*it.qty).toFixed(2)}${it.comment?` - (${escapeHtml(it.comment)})`:''}</li>`; });
  html += `</ul><div><strong>Total: ${fmt(ticket.total)}</strong></div>`;
  html += `</body></html>`;
  w.document.write(html); w.document.close();
}

// ============== CLOSE SHIFT (code 22782522) ==============
document.getElementById('btnCloseShift').onclick = ()=>{
  const code = prompt('Ingrese c√≥digo de cierre:');
  if(code === null) return;
  if(code !== '22782522'){ alert('C√≥digo incorrecto'); return; }
  const hist = JSON.parse(localStorage.getItem('sales_v3')||'[]');
  if(hist.length === 0){ alert('No hay ventas para cierre'); return; }
  let totalEfectivo = 0, totalTarjeta = 0, totalGeneral = 0;
  hist.forEach(h=>{
    if((h.method || '').toUpperCase().includes('EFECTIVO')) totalEfectivo += h.total;
    else totalTarjeta += h.total;
    totalGeneral += h.total;
  });
  const cierre = { date: new Date().toISOString(), totalEfectivo, totalTarjeta, totalGeneral, tickets: hist.map(h=>({ id: h.id, label: h.label, date: h.dateFormatted, total: h.total, method: h.method })) };
  const html = generateCloseHTML(cierre);
  const w = window.open('', '_blank', 'width=420,height=720');
  if(!w){ alert('No se pudo abrir ventana de impresi√≥n. Permite pop-ups.'); return; }
  w.document.open(); w.document.write(html); w.document.close();
  setTimeout(()=>{ try{ w.print(); }catch(e){ console.warn(e); } }, 300);
  // after printing, clear history
  localStorage.setItem('sales_v3', JSON.stringify([]));
  broadcastState('sales_v3', JSON.stringify([]));
  alert('Cierre realizado. Historial de ventas eliminado.');
  renderHistory();
};

function generateCloseHTML(cierre){
  const logoSrc = 'logo';
  return `<!doctype html><html><head><meta charset="utf-8"><title>Cierre</title>
    <style>@media print{@page{size:80mm auto;margin:3mm}} body{font-family:Arial;padding:6px;margin:0}.ticket{width:76mm;margin:0 auto}.center{text-align:center}.total{font-weight:700}</style>
    </head><body onload="setTimeout(()=>{ window.print(); },150)">
      <div class="ticket">
        <img src="${logoSrc}" style="max-width:72mm;display:block;margin:0 auto 6px" onerror="this.onerror=null;this.src='logo.png';"/>
        <div class="center" style="font-weight:700">CIERRE DE VENTAS - TORTILLAS DE HARINA LAS PICONAS</div>
        <div class="center">${escapeHtml(new Date(cierre.date).toLocaleString())}</div>
        <div style="margin-top:8px">Total Efectivo: Q${cierre.totalEfectivo.toFixed(2)}</div>
        <div>Total Tarjeta: Q${cierre.totalTarjeta.toFixed(2)}</div>
        <div style="margin-top:6px;font-weight:700">Total General: Q${cierre.totalGeneral.toFixed(2)}</div>
        <div style="margin-top:8px;font-size:12px">Tickets incluidos:</div>
        <div style="font-size:12px">${cierre.tickets.map(t=>`${escapeHtml(t.label)} - ${escapeHtml(t.date)} - Q${t.total.toFixed(2)} - ${escapeHtml(t.method)}`).join('<br/>')}</div>
      </div>
    </body></html>`;
}

// ============== INIT & EVENTS =================
function init(){
  renderCategories();
  renderHistory();
  renderViewer();
  updateCurrentOrderUI();
  // hide cobrar until login
  document.getElementById('btnCobrarTop').style.display = 'none';
}
init();

// login flow
document.getElementById('btnLogin').onclick = ()=>{
  const u = document.getElementById('user').value;
  const p = document.getElementById('pass').value;
  if(u==='CAJERO' && p==='123'){
    document.getElementById('login').style.display = 'none';
    document.getElementById('appRoot').style.display = 'grid';
    // show cobrar button now
    document.getElementById('btnCobrarTop').style.display = 'block';
    renderCategories(); renderHistory(); renderViewer(); updateCurrentOrderUI(); showAdminMenu();
  } else {
    alert('Usuario o clave incorrecta');
  }
};

// link cobrar top to finalize
document.getElementById('btnCobrarTop').onclick = ()=> finalizeSale();
document.getElementById('finalizar').onclick = ()=> finalizeSale();

// misc UI events
document.getElementById('btnAddCategory').onclick = ()=> addCategory();
document.getElementById('btnAddProduct').onclick = ()=> addProduct();
document.getElementById('plus').onclick = ()=> document.getElementById('qty').stepUp();
document.getElementById('minus').onclick = ()=> document.getElementById('qty').stepDown();
document.getElementById('btnDeleteLast').onclick = ()=>{ if(cart.length>0){ cart.pop(); persistWorkingCart(); broadcastState('current_cart_working', JSON.stringify(cart)); renderViewer(); } };
document.getElementById('coupon').onclick = ()=>{ const d = parseFloat(prompt('Ingrese descuento Q')); if(!isNaN(d)){ discount = d; recalc(); } };
document.getElementById('btnSearch').onclick = ()=>{ const q=document.getElementById('searchId').value.trim(); renderHistory(q); };
document.getElementById('btnExport').onclick = ()=>{ const data=localStorage.getItem('sales_v3') || '[]'; const blob=new Blob([data],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='ventas.json'; a.click(); };

// change order number button next to totals
document.getElementById('btnChangeOrder').onclick = ()=>{
  const v = prompt('Ingrese n√∫mero para el pr√≥ximo orden (ej: 25 significa A25):', String(orderCounter));
  if(!v) return;
  const n = Number(v);
  if(isNaN(n) || n<1){ alert('N√∫mero inv√°lido'); return; }
  orderCounter = n;
  localStorage.setItem('order_counter', orderCounter);
  broadcastState('order_counter', String(orderCounter));
  updateCurrentOrderUI();
  alert('N√∫mero de orden actualizado a A ' + orderCounter);
};

// payment method buttons
document.getElementById('btn-cash').onclick = ()=> { paymentMethod='EFECTIVO'; document.getElementById('btn-cash').classList.add('pay-active'); document.getElementById('btn-card').classList.remove('pay-active'); };
document.getElementById('btn-card').onclick = ()=> { paymentMethod='TARJETA'; document.getElementById('btn-card').classList.add('pay-active'); document.getElementById('btn-cash').classList.remove('pay-active'); };


// === HAMBURGUESA Y ADMINISTRACI√ìN ===
const coloresIntensos = ["#e74c3c","#27ae60","#2980b9","#f39c12","#8e44ad","#d35400","#16a085","#c0392b"];
function toggleMenu(){ const m=document.getElementById('menuLateral'); m.style.left = (m.style.left==='0px')?'-260px':'0px'; }
document.getElementById('menuHamburguesa').onclick = toggleMenu;

Array.from(document.querySelectorAll('#menuLateral a')).forEach(a=>{
  a.onclick = (ev)=>{
    ev.preventDefault(); toggleMenu();
    const act = a.dataset.action;
    const code = prompt('Ingrese clave de administrador:');
    if(code!=='22782522'){ alert('Clave incorrecta'); return; }
    if(act==='addCat') addCategory();
    else if(act==='editCat'){ const n=prompt('Nombre de la categor√≠a a modificar:'); if(n&&CATEGORIES[n]) editCategory(n); else alert('Categor√≠a no encontrada.'); }
    else if(act==='delCat'){ const n=prompt('Nombre de la categor√≠a a eliminar:'); if(n&&CATEGORIES[n]) deleteCategory(n); else alert('Categor√≠a no encontrada.'); }
    else if(act==='addProd') addProduct();
    else if(act==='editProd'){ const c=prompt('Categor√≠a del producto:'); if(c&&CATEGORIES[c]){ const p=prompt('√çndice o nombre del producto:'); editProduct(c,0); } }
    else if(act==='delProd'){ const c=prompt('Categor√≠a del producto:'); if(c&&CATEGORIES[c]) deleteProduct(c,0); }
  };
});

// Mostrar men√∫ despu√©s del login
function showAdminMenu(){ document.getElementById('menuHamburguesa').style.display='block'; }

// === COLORES AUTOM√ÅTICOS INTENSOS ===
function getNextColor(){
  const used = Object.values(CATEGORIES).map(c=>c.color);
  for(let col of coloresIntensos){ if(!used.includes(col)) return col; }
  return coloresIntensos[Math.floor(Math.random()*coloresIntensos.length)];
}

// Sobrescribir addCategory y addProduct m√≠nimamente
const oldAddCategory = addCategory;
addCategory = function(){
  const name = prompt('Nombre de la nueva categor√≠a:');
  if(!name) return;
  if(CATEGORIES[name]){ alert('Categor√≠a ya existe'); return; }
  const color = getNextColor();
  CATEGORIES[name] = { color: color, products: [] };
  persistCategories(); renderCategories();
};

const oldAddProduct = addProduct;
addProduct = function(){
  const cat = prompt('Categor√≠a del producto:');
  if(!cat) return alert('Ingrese categor√≠a');
  if(!CATEGORIES[cat]) return alert('Categor√≠a no existe');
  const name = prompt('Nombre del producto:');
  if(!name) return alert('Ingrese nombre');
  const price = parseFloat(prompt('Precio del producto:'));
  if(isNaN(price)) return alert('Precio inv√°lido');
  const color = CATEGORIES[cat].color || getNextColor();
  CATEGORIES[cat].products.push({ name, price, color });
  persistCategories(); showProducts(cat);
};

// sync between windows
window.addEventListener('storage', (ev)=>{
  if(!ev.key) return;
  try{
    if(ev.key === 'categories_v3' && ev.newValue){ CATEGORIES = JSON.parse(ev.newValue); renderCategories(); }
    else if(ev.key === 'sales_v3'){ renderHistory(); }
    else if(ev.key === 'current_cart_working'){ try{ cart = JSON.parse(ev.newValue || '[]'); }catch(e){ cart = []; } renderViewer(); }
    else if(ev.key === 'order_counter'){ orderCounter = Number(ev.newValue || 1); updateCurrentOrderUI(); }
  }catch(e){ console.warn('sync failed', e); }
});
</script>

</body>
</html>

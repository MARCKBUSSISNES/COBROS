<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Control Administrativo de Parqueo ‚Äî PICONAS</title>

  <!-- Chart.js para gr√°ficas -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#0b1220; --panel:#0f1724; --accent:#06b6d4; --accent-2:#ff7a59; --card:#071021;
      --muted:#9aa6b2; --glass: rgba(255,255,255,0.03); --radius:12px;
      --success:#10b981; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; background:linear-gradient(180deg,#071021 0%, #081428 60%); color:#e6eef3}
    .app{display:grid; grid-template-columns:260px 1fr; gap:18px; padding:20px; min-height:100vh;}
    @media(max-width:900px){ .app{grid-template-columns:1fr} .sidebar{order:2} .main{order:1} }

    /* SIDEBAR */
    .sidebar{background:var(--panel); border-radius:var(--radius); padding:14px; box-shadow:0 10px 30px rgba(2,6,23,0.6)}
    .brand{display:flex; gap:12px; align-items:center; margin-bottom:8px}
    .logo{width:44px;height:44px;border-radius:8px;background:linear-gradient(90deg,var(--accent),#0ea5ad);display:flex;align-items:center;justify-content:center;font-weight:700;color:#001;box-shadow:0 6px 18px rgba(6,182,212,0.12)}
    .menu{display:flex;flex-direction:column;gap:6px;margin-top:8px}
    .menu button{background:transparent;border:none;color:var(--muted);text-align:left;padding:8px 10px;border-radius:8px;cursor:pointer}
    .menu button.active{color:var(--accent);background:linear-gradient(90deg, rgba(6,182,212,0.06), rgba(255,122,89,0.03));font-weight:600}

    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.08)); padding:12px; border-radius:10px}
    .small{font-size:13px;color:var(--muted)}

    /* HEADER (within main) */
    .topbar{display:flex;justify-content:space-between;gap:12px;align-items:center;margin-bottom:12px}
    .actions{display:flex;gap:8px;align-items:center}
    .btn{padding:8px 12px;border-radius:8px;border:none;background:transparent;color:inherit;cursor:pointer}
    .btn.primary{background:linear-gradient(90deg,var(--accent),#0ea5ad);color:#002026}
    .btn.warn{background:linear-gradient(90deg,var(--accent-2),#ff936e);color:#2b0d00}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04)}

    /* FORM */
    .form-row{display:flex;gap:8px;align-items:center}
    .form-row input{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    .form-row .wide{flex:1}

    /* TABLE */
    .table-wrap{overflow:auto; margin-top:12px}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.03); text-align:center}
    th{color:var(--muted);font-weight:600;background:rgba(0,0,0,0.15)}
    tr.active{background:linear-gradient(90deg, rgba(6,182,212,0.04), rgba(255,255,89,0.01))}

    .summary{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
    .stat{background:var(--card);padding:12px;border-radius:10px;min-width:140px;text-align:center}
    .stat h3{margin:0;font-size:18px}
    .stat p{margin:6px 0 0;color:var(--muted)}

    footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}

    /* small helpers */
    .badge{padding:6px 10px;border-radius:999px;font-size:12px}
    .badge.green{background:rgba(16,185,129,0.12);color:var(--success)}
    .badge.yellow{background:rgba(250,204,21,0.12);color:#eab308}
    .barcode{max-width:180px}
  </style>
</head>
<body>
  <div class="app">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">P</div>
        <div>
          <div style="font-weight:700">PICONAS - Parqueo</div>
          <div class="small">Administraci√≥n</div>
        </div>
      </div>

      <div class="menu" id="menu">
        <button data-view="dashboard" class="active">üìä Dashboard</button>
        <button data-view="registro">üöó Registro</button>
        <button data-view="export">‚¨áÔ∏è Exportar/Importar</button>
        <button data-view="config">‚öôÔ∏è Configuraci√≥n</button>
      </div>

      <div style="margin-top:12px" class="small">
        Admin console ‚Ä¢ Datos guardados en el navegador (LocalStorage)
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <div class="topbar">
        <div>
          <h2 style="margin:0">Control Administrativo de Parqueo</h2>
          <div class="small">Panel central ‚Äî Mantiene tarifas y l√≥gica original</div>
        </div>
        <div class="actions">
          <input id="search" placeholder="Buscar por placa o marca..." class="btn ghost" style="padding:8px 12px" />
          <button class="btn" id="btnClearAll" title="Limpiar todo (borrar datos)">Limpiar datos</button>
          <button class="btn primary" id="btnExportCSV">Exportar CSV</button>
          <button class="btn" id="btnPrintSummary">Imprimir resumen</button>
        </div>
      </div>

      <!-- DASHBOARD VIEW -->
      <section id="view-dashboard" class="card view">
        <div style="display:flex;gap:12px;align-items:flex-start">
          <div style="flex:1">
            <div class="card">
              <h3 style="margin:0">Registrar ingreso r√°pido</h3>
              <div style="height:10px"></div>
              <div class="form-row">
                <input id="placa" class="wide" placeholder="Placa del veh√≠culo" autofocus />
                <input id="marca" placeholder="Marca" style="width:180px" />
                <button class="btn primary" id="btnIngresar">Ingresar</button>
                <button class="btn warn" id="btnGym">GYM (Q0)</button>
              </div>
            </div>

            <div class="card" style="margin-top:12px">
              <h3 style="margin:0">Registros</h3>
              <div class="table-wrap">
                <table>
                  <thead>
                    <tr><th>Placa</th><th>Marca</th><th>Ingreso</th><th>Salida</th><th>Total Q</th><th>Acciones</th></tr>
                  </thead>
                  <tbody id="registro"></tbody>
                </table>
              </div>
            </div>
          </div>

          <aside style="width:360px">
            <div class="card">
              <h3 style="margin:0">Resumen del Turno</h3>
              <div class="summary" id="resumenStats">
                <div class="stat"><h3 id="statActivos">0</h3><p>Veh√≠culos activos</p></div>
                <div class="stat"><h3 id="statTotal">Q0.00</h3><p>Total recaudado</p></div>
                <div class="stat"><h3 id="statEntradas">0</h3><p>Entradas hoy</p></div>
              </div>
              <div style="height:12px"></div>
              <canvas id="chart" height="200"></canvas>
            </div>

            <div class="card" style="margin-top:12px">
              <h4 style="margin:0">Detalle R√°pido</h4>
              <div style="height:8px"></div>
              <div class="small">Selecciona un registro para ver m√°s y generar ticket o factura</div>
            </div>
          </aside>
        </div>
      </section>

      <!-- REGISTRO VIEW -->
      <section id="view-registro" class="card view" style="display:none; margin-top:12px">
        <h3>Historial completo</h3>
        <div class="table-wrap">
          <table>
            <thead><tr><th>#</th><th>Placa</th><th>Marca</th><th>Ingreso</th><th>Salida</th><th>Minutos</th><th>Total Q</th><th>Acciones</th></tr></thead>
            <tbody id="historial"></tbody>
          </table>
        </div>
      </section>

      <!-- EXPORT / IMPORT -->
      <section id="view-export" class="card view" style="display:none; margin-top:12px">
        <h3>Exportar / Importar datos</h3>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn primary" id="exportJSON">Exportar JSON</button>
          <button class="btn" id="importJSONBtn">Importar JSON</button>
          <input type="file" id="fileImport" accept="application/json" style="display:none" />
        </div>
        <div style="margin-top:12px" id="importResult"></div>
      </section>

      <!-- CONFIG -->
      <section id="view-config" class="card view" style="display:none; margin-top:12px">
        <h3>Configuraci√≥n</h3>
        <p class="small">Sin login (modo administrativo local). Aqu√≠ puedes ajustar datos si lo deseas en pr√≥ximas versiones.</p>
        <div style="margin-top:8px">
          <button class="btn" id="btnResetTarifas">Restaurar tarifas originales</button>
        </div>
      </section>

      <footer class="small">&copy; MarckBusiness 2025 ‚Äî Sistema administrativo</footer>
    </main>
  </div>

  <script>
    // -----------------------------
    // Administraci√≥n avanzada (sin login)
    // -----------------------------
    const STORAGE_KEY = 'parqueo_admin_v2';
    let registros = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');

    // Mantener exactamente las mismas tarifas originales:
    const tarifas = [
      { min: 0, max: 5, precio: 0 },
      { min: 6, max: 35, precio: 5 },
      { min: 36, max: 65, precio: 8 },
      { min: 66, max: 95, precio: 13 },
      { min: 96, max: 125, precio: 16 },
      { min: 126, max: 155, precio: 21 },
      { min: 156, max: 185, precio: 24 },
      { min: 186, max: 215, precio: 29 },
      { min: 216, max: 245, precio: 32 },
      { min: 246, max: 275, precio: 37 },
      { min: 276, max: 305, precio: 40 },
      { min: 306, max: 335, precio: 45 },
      { min: 336, max: 365, precio: 48 },
      { min: 366, max: 395, precio: 53 },
      { min: 396, max: 425, precio: 56 },
      { min: 426, max: 455, precio: 61 },
      { min: 456, max: 485, precio: 64 },
      { min: 486, max: 515, precio: 69 },
      { min: 516, max: 545, precio: 72 },
      { min: 546, max: 575, precio: 77 },
      { min: 576, max: 605, precio: 80 },
      { min: 606, max: 635, precio: 85 },
      { min: 636, max: 665, precio: 88 }
    ];

    // ---------- UTILIDADES ----------
    function save() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(registros));
    }

    function uid(prefix='id') { return prefix + '_' + Math.random().toString(36).slice(2,9); }

    // ---------- C√ÅLCULO (misma l√≥gica y tarifas) ----------
    function calcularPago(horaIngreso, horaSalida) {
      const entrada = new Date(horaIngreso);
      const salida = new Date(horaSalida);
      const minutos = Math.ceil((salida - entrada) / 60000);

      for (let i = 0; i < tarifas.length; i++) {
        if (minutos >= tarifas[i].min && minutos <= tarifas[i].max) {
          return tarifas[i].precio;
        }
      }
      return tarifas[tarifas.length - 1].precio;
    }

    // ---------- RENDER TABLA PRINCIPAL ----------
    function actualizarTabla() {
      const tbody = document.getElementById('registro');
      tbody.innerHTML = '';
      registros.forEach((r, idx) => {
        const tr = document.createElement('tr');
        if (!r.horaSalida) tr.classList.add('active');
        tr.innerHTML = `
          <td>${r.placa}</td>
          <td>${r.marca}</td>
          <td>${new Date(r.horaIngreso).toLocaleString()}</td>
          <td>${r.horaSalida ? new Date(r.horaSalida).toLocaleString() : '-'}</td>
          <td>${r.total != null ? 'Q' + Number(r.total).toFixed(2) : '-'}</td>
          <td>
            ${r.horaSalida ? '' : `<button class="btn" data-idx="${idx}" data-action="salir">Salir</button>
            <button class="btn ghost" data-idx="${idx}" data-action="gym">GYM</button>`}
            <button class="btn ghost" data-idx="${idx}" data-action="ticket">Ticket</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      actualizarResumen();
      renderHistorial();
      save();
    }

    // ---------- ACCIONES ----------
    document.getElementById('btnIngresar').addEventListener('click', () => {
      const placaEl = document.getElementById('placa');
      const marcaEl = document.getElementById('marca');
      const placa = (placaEl.value || '').trim();
      const marca = (marcaEl.value || '').trim();
      if (!placa || !marca) return alert('Ingrese placa y marca');
      const hora = new Date().toISOString();
      registros.push({ id: uid('r'), placa, marca, horaIngreso: hora, horaSalida: null, total: null });
      placaEl.value = ''; marcaEl.value = '';
      placaEl.focus();
      imprimirTicket(placa, marca, hora);
      actualizarTabla();
    });

    // GYM bot√≥n: cobrar Q0 y marcar salida
    document.getElementById('btnGym').addEventListener('click', () => {
      const placaEl = document.getElementById('placa');
      const marcaEl = document.getElementById('marca');
      const placa = (placaEl.value || '').trim();
      const marca = (marcaEl.value || '').trim();
      if (!placa || !marca) return alert('Ingrese placa y marca');
      const hora = new Date().toISOString();
      const rec = { id: uid('r'), placa, marca, horaIngreso: hora, horaSalida: new Date().toISOString(), total: 0 };
      registros.push(rec);
      placaEl.value = ''; marcaEl.value = '';
      imprimirFacturaGYM(rec);
      actualizarTabla();
    });

    // Delegaci√≥n de eventos en la tabla
    document.getElementById('registro').addEventListener('click', (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;
      const idx = Number(btn.dataset.idx);
      const action = btn.dataset.action;
      if (action === 'salir') sacarVehiculo(idx);
      if (action === 'gym') marcarGYM(idx);
      if (action === 'ticket') imprimirTicketFromIndex(idx);
    });

    // sacarVehiculo (salida normal)
    function sacarVehiculo(index) {
      const salida = new Date().toISOString();
      registros[index].horaSalida = salida;
      registros[index].total = calcularPago(registros[index].horaIngreso, salida);
      imprimirFactura(registros[index]);
      actualizarTabla();
    }

    // marcar GYM desde tabla (0.00)
    function marcarGYM(index) {
      const salida = new Date().toISOString();
      registros[index].horaSalida = salida;
      registros[index].total = 0;
      imprimirFacturaGYM(registros[index]);
      actualizarTabla();
    }

    function imprimirTicketFromIndex(index) {
      const r = registros[index];
      imprimirTicket(r.placa, r.marca, r.horaIngreso);
    }

    // ---------- IMPRESI√ìN (tickets y facturas) ----------
    function imprimirHTMLWindow(contentHtml, options = {}) {
      const w = window.open('', '_blank', 'width=380,height=640');
      w.document.write(contentHtml);
      w.document.close();
      if (!options.noPrint) setTimeout(() => w.print(), 400);
    }

    function imprimirTicket(placa, marca, hora) {
      const fecha = new Date(hora);
      const fechaStr = fecha.toLocaleDateString();
      const horaStr = fecha.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const barcodeURL = `https://barcode.tec-it.com/barcode.ashx?data=${encodeURIComponent(placa)}&code=Code128&translate-esc=false`;

      const html = `
      <html><head><meta charset="utf-8"><title>Ticket</title>
      <style>
        body{font-family:monospace;text-align:center;padding:10px}
        .line{border-top:1px dashed #000;margin:10px 0}
        .big{font-size:18pt;font-weight:700}
        img{max-width:100%;height:auto}
      </style></head><body>
        <img src="IMAGEN1.jpg" alt="logo" style="max-width:200px"/>
        <div class="line"></div>
        <div>FECHA</div><div>${fechaStr}</div>
        <div class="line"></div>
        <div>HORA DE INGRESO</div><div class="big">${horaStr}</div>
        <div class="line"></div>
        <div>PLACA</div><div class="big">${placa}</div>
        <div class="line"></div>
        <div>MARCA</div><div class="big">${marca}</div>
        <div class="line"></div>
        <div><img src="${barcodeURL}" class="barcode" /></div>
        <div class="line"></div>
        <pre>Gracias por su visita\n*RECUERDE NO PERDER SU TICKET*</pre>
      </body></html>`;
      imprimirHTMLWindow(html);
    }

    function imprimirFactura(dato) {
      const entrada = new Date(dato.horaIngreso);
      const salida = new Date(dato.horaSalida);
      const tiempo = Math.ceil((salida - entrada) / 60000);
      const barcodeURL = `https://barcode.tec-it.com/barcode.ashx?data=${encodeURIComponent(dato.placa)}&code=Code128&translate-esc=false`;
      const html = `
      <html><head><meta charset="utf-8"><title>Factura</title>
      <style>
        body{font-family:monospace;text-align:center;padding:10px}
        .line{border-top:1px dashed #000;margin:10px 0}
        .big{font-size:18pt;font-weight:700}
      </style></head><body>
        <img src="IMAGEN1.jpg" alt="logo" style="max-width:200px"/>
        <div class="line"></div>
        <div>FACTURA VEH√çCULO</div>
        <div class="line"></div>
        <div>PLACA</div><div class="big">${dato.placa}</div>
        <div class="line"></div>
        <div>MARCA</div><div class="big">${dato.marca}</div>
        <div class="line"></div>
        <div>ENTRADA</div><div>${entrada.toLocaleString()}</div>
        <div class="line"></div>
        <div>SALIDA</div><div>${salida.toLocaleString()}</div>
        <div class="line"></div>
        <div>TIEMPO TOTAL</div><div class="big">${tiempo} minutos</div>
        <div class="line"></div>
        <div>TOTAL A PAGAR</div><div class="big">Q${Number(dato.total).toFixed(2)}</div>
        <div class="line"></div>
        <div><img src="${barcodeURL}" class="barcode" /></div>
        <div class="line"></div>
        <pre>Gracias por su visita</pre>
      </body></html>`;
      imprimirHTMLWindow(html);
    }

    function imprimirFacturaGYM(dato) {
      const entrada = new Date(dato.horaIngreso);
      const salida = new Date(dato.horaSalida);
      const tiempo = Math.ceil((salida - entrada) / 60000);
      const barcodeURL = `https://barcode.tec-it.com/barcode.ashx?data=${encodeURIComponent(dato.placa)}&code=Code128&translate-esc=false`;
      const html = `
      <html><head><meta charset="utf-8"><title>Factura GYM</title>
      <style>
        body{font-family:monospace;text-align:center;padding:10px}
        .line{border-top:1px dashed #000;margin:10px 0}
        .big{font-size:18pt;font-weight:700;color:#388e3c}
      </style></head><body>
        <img src="IMAGEN1.jpg" alt="logo" style="max-width:200px"/>
        <div class="line"></div>
        <div>FACTURA VEH√çCULO GYM üí™</div>
        <div class="line"></div>
        <div>PLACA</div><div class="big">${dato.placa}</div>
        <div class="line"></div>
        <div>MARCA</div><div class="big">${dato.marca}</div>
        <div class="line"></div>
        <div>ENTRADA</div><div>${entrada.toLocaleString()}</div>
        <div class="line"></div>
        <div>SALIDA</div><div>${salida.toLocaleString()}</div>
        <div class="line"></div>
        <div>TIEMPO TOTAL</div><div class="big">${tiempo} minutos</div>
        <div class="line"></div>
        <div>TOTAL A PAGAR</div><div class="big">Q0.00</div>
        <div class="line"></div>
        <div><img src="${barcodeURL}" class="barcode" /></div>
        <div class="line"></div>
        <pre>Gracias por su visita\nPARQUEO PARA GYM</pre>
      </body></html>`;
      imprimirHTMLWindow(html);
    }

    // ---------- RESUMEN Y GR√ÅFICO ----------
    function actualizarResumen() {
      const activos = registros.filter(r => !r.horaSalida).length;
      const total = registros.reduce((s, r) => s + (r.total || 0), 0);
      const hoy = registros.filter(r => new Date(r.horaIngreso).toDateString() === new Date().toDateString()).length;
      document.getElementById('statActivos').innerText = activos;
      document.getElementById('statTotal').innerText = 'Q' + total.toFixed(2);
      document.getElementById('statEntradas').innerText = hoy;
      renderChart();
    }

    let chartInstance = null;
    function renderChart() {
      const ctx = document.getElementById('chart').getContext('2d');
      // agrupar por hora del d√≠a (ejemplo resumen)
      const buckets = {};
      registros.forEach(r => {
        const h = new Date(r.horaIngreso).getHours();
        buckets[h] = (buckets[h] || 0) + 1;
      });
      const labels = Array.from({length:24}, (_,i) => String(i).padStart(2,'0') + ':00');
      const data = labels.map(l => buckets[Number(l.slice(0,2))] || 0);
      if (chartInstance) chartInstance.destroy();
      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label: 'Entradas por hora', data, backgroundColor: 'rgba(6,182,212,0.85)' }] },
        options: { responsive:true, plugins:{legend:{display:false}} }
      });
    }

    // ---------- HISTORIAL DETALLADO ----------
    function renderHistorial() {
      const tbody = document.getElementById('historial');
      tbody.innerHTML = '';
      registros.forEach((r, i) => {
        const minutos = r.horaSalida ? Math.ceil((new Date(r.horaSalida) - new Date(r.horaIngreso))/60000) : '-';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${r.placa}</td>
          <td>${r.marca}</td>
          <td>${new Date(r.horaIngreso).toLocaleString()}</td>
          <td>${r.horaSalida ? new Date(r.horaSalida).toLocaleString() : '-'}</td>
          <td>${minutos}</td>
          <td>${r.total != null ? 'Q' + Number(r.total).toFixed(2) : '-'}</td>
          <td><button class="btn" data-idx="${i}" data-action="view">Ver</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ---------- EXPORT / IMPORT ----------
    document.getElementById('exportJSON').addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(registros, null, 2)], { type:'application/json' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'parqueo_backup_'+(new Date()).toISOString().slice(0,10)+'.json'; a.click();
    });
    document.getElementById('importJSONBtn').addEventListener('click', () => document.getElementById('fileImport').click());
    document.getElementById('fileImport').addEventListener('change', (e) => {
      const f = e.target.files[0]; if(!f) return;
      const r = new FileReader(); r.onload = () => {
        try {
          const data = JSON.parse(r.result);
          if (!Array.isArray(data)) return alert('Archivo inv√°lido');
          // preguntar si reemplazar o fusionar
          if (confirm('¬øReemplazar registros actuales con este backup? (Aceptar = reemplazar)')) {
            registros = data;
          } else {
            registros = registros.concat(data);
          }
          save(); actualizarTabla(); alert('Importaci√≥n completada');
        } catch (err) { alert('Error al leer archivo'); }
      };
      r.readAsText(f);
    });

    document.getElementById('exportJSON')?.addEventListener('click', () => { /* ya manejado arriba */ });

    // Export CSV (simple)
    document.getElementById('btnExportCSV').addEventListener('click', () => {
      const rows = [['placa','marca','horaIngreso','horaSalida','total']];
      registros.forEach(r => rows.push([r.placa, r.marca, r.horaIngreso, r.horaSalida || '', r.total || 0]));
      const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type:'text/csv' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'parqueo_'+(new Date()).toISOString().slice(0,10)+'.csv'; a.click();
    });

    // ---------- LIMPIEZA / CIERRE TURNO ----------
    document.getElementById('btnClearAll').addEventListener('click', () => {
      if (!confirm('Borrar todos los registros actuales?')) return;
      registros = []; save(); actualizarTabla();
    });

    document.getElementById('btnPrintSummary').addEventListener('click', () => {
      const total = registros.reduce((s, r) => s + (r.total || 0), 0);
      const html = `<html><body style="font-family:monospace;text-align:center"><h2>CIERRE DE TURNO</h2><pre>TOTAL: Q${total.toFixed(2)}</pre></body></html>`;
      const w = window.open('','_blank'); w.document.write(html); w.document.close(); w.print();
    });

    // ---------- B√öSQUEDA Y FILTROS ----------
    document.getElementById('search').addEventListener('input', function() {
      const q = this.value.trim().toLowerCase();
      const tbody = document.getElementById('registro');
      Array.from(tbody.children).forEach(tr => {
        const placa = tr.children[0]?.innerText.toLowerCase() || '';
        const marca = tr.children[1]?.innerText.toLowerCase() || '';
        tr.style.display = (placa.includes(q) || marca.includes(q)) ? '' : 'none';
      });
    });

    // ---------- NAV VIEWS ----------
    document.getElementById('menu').addEventListener('click', (e) => {
      const b = e.target.closest('button');
      if (!b) return;
      document.querySelectorAll('#menu button').forEach(x => x.classList.remove('active'));
      b.classList.add('active');
      const view = b.dataset.view;
      document.querySelectorAll('.view').forEach(v => v.style.display = (v.id === 'view-' + view) ? '' : 'none');
    });

    // ---------- INICIALIZAR Y LIGAR EVENTOS ----------
    function init() {
      actualizarTabla();
      // botones por defecto: mostrar dashboard
      document.querySelector('#menu button[data-view="dashboard"]').click();
    }
    init();

    // Restaurar tarifas originales (no cambia nada si ya est√°n)
    document.getElementById('btnResetTarifas').addEventListener('click', () => {
      if (confirm('¬øRestaurar tarifas originales (no modifica registros) ?')) {
        alert('Las tarifas originales se mantienen por defecto.');
      }
    });

    // manejadores adicionales para historial (ver detalle)
    document.getElementById('historial').addEventListener('click', (e) => {
      const btn = e.target.closest('button'); if (!btn) return;
      const idx = Number(btn.dataset.idx); const action = btn.dataset.action;
      if (action === 'view') {
        const r = registros[idx];
        alert(`Placa: ${r.placa}\nMarca: ${r.marca}\nIngreso: ${new Date(r.horaIngreso).toLocaleString()}\nSalida: ${r.horaSalida ? new Date(r.horaSalida).toLocaleString() : '-'}\nTotal: ${r.total != null ? 'Q'+Number(r.total).toFixed(2) : '-'}`);
      }
    });

    // soporte para imprimir ticket desde inputs con Enter
    document.getElementById('placa').addEventListener('keyup', (e) => { if (e.key === 'Enter') document.getElementById('marca').focus(); });
    document.getElementById('marca').addEventListener('keyup', (e) => { if (e.key === 'Enter') document.getElementById('btnIngresar').click(); });

  </script>
</body>
</html>
